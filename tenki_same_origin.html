<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å…¨å›½å¤©æ°—3åˆ†å‰²ï¼‹æ²–ç¸„ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼ˆæ‰‹å‹•ã‚ºãƒ¼ãƒ è¨­å®šå¯¾å¿œï¼‰</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body {height:100%; margin:0; background:#0b1220;}
    .wrap {display:flex; height:100vh; width:100vw;}
    .panel {flex:1; border-left:1px solid #2c3143; position:relative; min-width:0;}
    .panel:first-child {border-left:none;}
    .map {position:absolute; inset:0;}
    .title{
      position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
      text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4); letter-spacing:.05em;
    }
    .wx-label{
      font-weight:700; font-size:16px; color:#fff; pointer-events:none;
      text-shadow:0 0 2px rgba(0,0,0,.65),0 0 4px rgba(0,0,0,.35);
    }
    .note{
      position:absolute; right:8px; bottom:6px; font-size:.8rem; opacity:.8; color:#cfd6ea;
    }
    /* èª¿æ•´ç”¨HUDï¼ˆedit=1 ã®ã¨ãã ã‘è¡¨ç¤ºï¼‰ */
    .hud{
      display:none; position:absolute; right:8px; top:6px; z-index:20;
      background:rgba(0,0,0,.35); color:#fff; padding:6px 8px; border-radius:8px;
      font-size:12px; line-height:1.4; box-shadow:0 4px 14px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }
    .hud .row{white-space:nowrap}
    .hud button{
      margin-left:6px; padding:2px 6px; border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.1); color:#fff; border-radius:6px; cursor:pointer;
    }
    .is-edit .hud{display:block;}

    /* å¹…ã®æ¯”ç‡ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰ */
    :root{ --w-kyushu:0.9; --w-honshu:1.2; --w-hokkaido:0.9; }
    .panel[data-region="kyushu"]   { flex: var(--w-kyushu); }
    .panel[data-region="honshu"]   { flex: var(--w-honshu); }
    .panel[data-region="hokkaido"] { flex: var(--w-hokkaido); }

    /* â–¼ æ²–ç¸„ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼ˆå·¦ãƒ‘ãƒãƒ«ã®ä¸­ã«å°çª“ãƒãƒƒãƒ—ï¼‰ */
    .inset {
      position:absolute; left:10px; bottom:10px; width:260px; height:170px; z-index:15;
      border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.15); background:rgba(10,14,26,.35); backdrop-filter: blur(2px);
    }
    .inset .inset-title{
      position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
      text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4);
    }
    .inset .inset-map{ width:100%; height:100%; }
    .inset .hud{ right:6px; top:6px; font-size:11px; padding:4px 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" data-region="kyushu">
      <div class="title">ä¹å·ãƒ»æ²–ç¸„</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-kyushu" class="map"></div>

      <!-- â–¼ æ²–ç¸„ã‚¤ãƒ³ã‚»ãƒƒãƒˆ -->
      <div class="inset" id="okinawa-inset">
        <div class="inset-title">æ²–ç¸„</div>
        <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
        <div id="okinawa-map" class="inset-map"></div>
      </div>
    </div>

    <div class="panel" data-region="honshu">
      <div class="title">æœ¬å·</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-honshu" class="map"></div>
    </div>

    <div class="panel" data-region="hokkaido">
      <div class="title">åŒ—æµ·é“</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-hokkaido" class="map"></div>
    </div>
  </div>
  <div class="note">åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ« / ãƒ‡ãƒ¼ã‚¿: Open-Meteo</div>

  <script>
  // ===== 1) åŸºæœ¬è¨­å®š =====
  const TILE = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png';
  const ATTR = '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>';

  const urlp = new URLSearchParams(location.search);
  const IS_EDIT = urlp.get('edit') === '1';
  if (IS_EDIT) document.body.classList.add('is-edit');

  const USE_FIXED_VIEW = true; // ã‚µã‚¤ãƒãƒ¼ã‚¸æ™‚ã¯å›ºå®šè¡¨ç¤º

  // â˜…æ‰‹å‹•ã§æ±ºã‚ãŸå›ºå®šãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å€¤ã‚’åæ˜ ï¼‰
  const PANEL_VIEW = {
    kyushu:   { center: [32.93989, 130.98492], zoom: 7 },
    honshu:   { center: [37.04665, 137.07624], zoom: 6 },
    hokkaido: { center: [41.76261, 142.96465], zoom: 6 },
  };
  // ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼ˆæ²–ç¸„ï¼‰ã®å›ºå®šãƒ“ãƒ¥ãƒ¼
  const INSET_VIEW = {
    okinawa:  { center: [26.21240, 127.68093], zoom: 9 }  // é‚£è¦‡ä¸­å¿ƒãƒ»ãŠå¥½ã¿ã§èª¿æ•´
  };

  // è‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆç”¨ã®ä¿é™ºï¼ˆå›ºå®šå€¤ã‚’ä½¿ã‚ãªã„å ´åˆï¼‰
  const REGION_BOUNDS = {
    kyushu:   [[24.0, 122.5], [34.2, 132.8]],
    honshu:   [[33.0, 130.0], [41.9, 142.5]],
    hokkaido: [[41.2, 139.0], [45.9, 146.5]],
    okinawa:  [[24.0, 122.5], [27.5, 129.5]],
  };
  const REGION_ZOOM_MAX = { kyushu:7, honshu:6, hokkaido:6, okinawa:10 };

  // ===== 2) éƒ½å¸‚ =====
  const PLACES = [
    // ä¹å·ãƒ»æ²–ç¸„
    { id:"fukuoka",   name:"ç¦å²¡å¸‚",   pref:"ç¦å²¡çœŒ",   lat:33.58333, lon:130.39999 },
    { id:"miyazaki",  name:"å®®å´å¸‚",   pref:"å®®å´çœŒ",   lat:31.90778, lon:131.42028 },
    { id:"kagoshima", name:"é¹¿å…å³¶å¸‚", pref:"é¹¿å…å³¶çœŒ", lat:31.56670, lon:130.55000 },
    { id:"naha",      name:"é‚£è¦‡å¸‚",   pref:"æ²–ç¸„çœŒ",   lat:26.21240, lon:127.68093 }, // ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«è¡¨ç¤º
    // æœ¬å·ï¼ˆå››å›½å«ã‚€ï¼‰
    { id:"osaka",     name:"å¤§é˜ªå¸‚",   pref:"å¤§é˜ªåºœ",   lat:34.69374, lon:135.50217 },
    { id:"nagoya",    name:"åå¤å±‹å¸‚", pref:"æ„›çŸ¥çœŒ",   lat:35.18145, lon:136.90640 },
    { id:"hiroshima", name:"åºƒå³¶å¸‚",   pref:"åºƒå³¶çœŒ",   lat:34.39161, lon:132.45182 },
    { id:"niigata",   name:"æ–°æ½Ÿå¸‚",   pref:"æ–°æ½ŸçœŒ",   lat:37.91611, lon:139.03639 },
    { id:"toyama",    name:"å¯Œå±±å¸‚",   pref:"å¯Œå±±çœŒ",   lat:36.69592, lon:137.21369 },
    { id:"morioka",   name:"ç››å²¡å¸‚",   pref:"å²©æ‰‹çœŒ",   lat:39.70000, lon:141.15000 },
    { id:"sendai",    name:"ä»™å°å¸‚",   pref:"å®®åŸçœŒ",   lat:38.26884, lon:140.87194 },
    { id:"chiyoda",   name:"åƒä»£ç”°",   pref:"æ±äº¬éƒ½",   lat:35.69000, lon:139.76000 },
    { id:"kisarazu",  name:"æœ¨æ›´æ´¥å¸‚", pref:"åƒè‘‰çœŒ",   lat:35.37610, lon:139.91700 },
    // åŒ—æµ·é“
    { id:"sapporo",   name:"æœ­å¹Œå¸‚",   pref:"åŒ—æµ·é“",   lat:43.06417, lon:141.34694 },
  ];

  // ===== 3) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function iconText(text){
    return L.divIcon({ className:"wx-label", html:text, iconSize:null, iconAnchor:[0,0] });
  }
  async function loadJSON(id){
    try{
      const res = await fetch(`data/${id}.json?ts=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) return null;
      return await res.json();
    }catch{ return null; }
  }
  function wcToEmoji(wc){
    return ({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",
             61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"})[wc] ?? "â›…";
  }
  const subset = region => region==="kyushu"
      ? PLACES.filter(p => ["ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref)) // â†ä¹å·ãƒ‘ãƒãƒ«ã‹ã‚‰æ²–ç¸„ã¯é™¤å¤–
      : region==="hokkaido"
      ? PLACES.filter(p => p.pref==="åŒ—æµ·é“")
      : PLACES.filter(p => !["åŒ—æµ·é“","ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"].includes(p.pref)); // æœ¬å·
  const subsetOkinawa = () => PLACES.filter(p => p.pref==="æ²–ç¸„çœŒ");

  // ===== 4) æ±ç”¨ãƒãƒƒãƒ—ï¼ˆ3ãƒ‘ãƒãƒ«ï¼‰ =====
  async function buildPanelMap(elId, regionKey){
    const panelEl = document.querySelector(`[data-region="${regionKey}"]`);
    const map = L.map(elId, {
      zoomControl: IS_EDIT, attributionControl:false,
      dragging: IS_EDIT, scrollWheelZoom: IS_EDIT, doubleClickZoom: IS_EDIT,
      touchZoom: IS_EDIT, boxZoom: IS_EDIT, keyboard: IS_EDIT
    });
    L.tileLayer(TILE, { attribution: ATTR, maxZoom: 18 }).addTo(map);

    if (USE_FIXED_VIEW && PANEL_VIEW[regionKey]){
      map.setView(PANEL_VIEW[regionKey].center, PANEL_VIEW[regionKey].zoom);
    } else {
      setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(REGION_BOUNDS[regionKey], { padding:[20,20] });
        const zmax = REGION_ZOOM_MAX[regionKey] ?? map.getZoom();
        if (map.getZoom() > zmax) map.setZoom(zmax);
      }, 0);
    }

    for(const p of subset(regionKey)){
      const j  = await loadJSON(p.id);
      const t  = j?.current?.temperature_2m;
      const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
      const label = (typeof t === "number") ? `${wcToEmoji(wc)} ${Math.round(t)}â„ƒ` : `${p.name}`;
      L.marker([p.lat,p.lon], { icon: iconText(label) }).addTo(map);
    }

    if (IS_EDIT) attachHud(map, panelEl.querySelector('.hud'), regionKey, 'panel');
    setTimeout(()=>map.invalidateSize(true),0);
    return map;
  }

  // ===== 5) æ²–ç¸„ã‚¤ãƒ³ã‚»ãƒƒãƒˆ =====
  async function buildOkinawaInset(){
    const el = document.getElementById('okinawa-inset');
    const map = L.map('okinawa-map', {
      zoomControl: IS_EDIT, attributionControl:false,
      dragging: IS_EDIT, scrollWheelZoom: IS_EDIT, doubleClickZoom: IS_EDIT,
      touchZoom: IS_EDIT, boxZoom: IS_EDIT, keyboard: IS_EDIT
    });
    L.tileLayer(TILE, { attribution: '', maxZoom: 18 }).addTo(map);

    if (USE_FIXED_VIEW && INSET_VIEW.okinawa){
      map.setView(INSET_VIEW.okinawa.center, INSET_VIEW.okinawa.zoom);
    } else {
      setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(REGION_BOUNDS.okinawa, { padding:[12,12] });
        const zmax = REGION_ZOOM_MAX.okinawa ?? map.getZoom();
        if (map.getZoom() > zmax) map.setZoom(zmax);
      }, 0);
    }

    for(const p of subsetOkinawa()){
      const j  = await loadJSON(p.id);
      const t  = j?.current?.temperature_2m;
      const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
      const label = (typeof t === "number") ? `${wcToEmoji(wc)} ${Math.round(t)}â„ƒ` : `${p.name}`;
      L.marker([p.lat,p.lon], { icon: iconText(label) }).addTo(map);
    }

    if (IS_EDIT) attachHud(map, el.querySelector('.hud'), 'okinawa', 'inset');
    setTimeout(()=>map.invalidateSize(true),0);
    return map;
  }

  // ===== 6) HUDï¼ˆCopy ã§è¨­å®šã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å–å¾—ï¼‰ =====
  function attachHud(map, hudEl, key, kind){
    const latEl = hudEl.querySelector('.lat'), lonEl = hudEl.querySelector('.lon'), zEl = hudEl.querySelector('.z');
    const copyBtn = hudEl.querySelector('.copy');
    const updateHud = () => {
      const c = map.getCenter();
      latEl.textContent = c.lat.toFixed(5);
      lonEl.textContent = c.lng.toFixed(5);
      zEl.textContent = map.getZoom().toFixed(0);
    };
    map.on('moveend zoomend', updateHud); updateHud();
    copyBtn.addEventListener('click', async () => {
      const c = map.getCenter(), z = map.getZoom();
      const snippet = (kind==='inset')
        ? `  okinawa: { center: [${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}], zoom: ${z} },`
        : `  ${key}: { center: [${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}], zoom: ${z} },`;
      try { await navigator.clipboard.writeText(snippet); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1500); }
      catch { alert(snippet); }
    });
  }

  // ===== 7) åˆæœŸåŒ– =====
  window.addEventListener("load", async () => {
    await Promise.all([
      buildPanelMap("map-kyushu",   "kyushu"),
      buildPanelMap("map-honshu",   "honshu"),
      buildPanelMap("map-hokkaido", "hokkaido"),
      buildOkinawaInset(),
    ]);
    if (!IS_EDIT) {
      setInterval(() => {
        const base = location.href.split("#")[0].split("?")[0];
        location.replace(`${base}?v=${Date.now()}`);
      }, 10*60*1000);
    }
  });
  </script>
</body>
</html>
