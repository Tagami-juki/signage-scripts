<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å…¨å›½ã®ãŠå¤©æ°—ï½œ3åˆ†å‰²ï¼‹ä¹å·/æ²–ç¸„ï¼ˆ7:3ï¼‰</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body {height:100%; margin:0; background:#0b1220; color:#fff;}

    :root{
      /* ä¸Šéƒ¨å¸¯ã®é«˜ã• */
      --topbar-h: 48px;

      /* 3ã‚«ãƒ©ãƒ ã®æ¨ªå¹…æ¯”ç‡ï¼ˆå·¦=ä¹å·+æ²–ç¸„ / ä¸­å¤®=æœ¬å· / å³=åŒ—æµ·é“ï¼‰ */
      --w-left:   0.9;
      --w-center: 1.2;
      --w-right:  0.9;

      /* å·¦ã‚«ãƒ©ãƒ ï¼šä¸Š=ä¹å· / ä¸‹=æ²–ç¸„ ã®ç¸¦æ¯”ç‡ï¼ˆ7:3ï¼‰ */
      --h-kyushu:  7;
      --h-okinawa: 3;

      /* å¤©æ°—ãƒ©ãƒ™ãƒ«ã®å€ç‡ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã¨æ¸©åº¦ã‚’åˆ¥ã€…ã«ï¼‰ */
      --emoji-scale: 1.9;  /* 1.6ã€œ2.2 ãã‚‰ã„ã§èª¿æ•´ */
      --temp-scale:  1.2;  /* 1.0ã€œ1.4 ãã‚‰ã„ã§èª¿æ•´ */
    }

    /* ä¸Šéƒ¨ã®å¸¯ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ */
    .topbar{
      position: fixed; left:0; right:0; top:0; height: var(--topbar-h);
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding: 0 20px;
      background: rgba(11,18,32,.72);
      color:#fff; z-index:999;
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 12px rgba(0,0,0,.35);
    }
    .topbar__title{
      font-weight:800; font-size:28px; letter-spacing:.05em;
      text-shadow: 0 2px 6px rgba(0,0,0,.45);
    }
    .topbar__meta{ font-size:14px; opacity:.9; }

    /* æœ¬æ–‡ï¼ˆãƒãƒƒãƒ—3åˆ†å‰²ï¼‰ */
    .wrap{
      display:flex; width:100vw;
      height: calc(100vh - var(--topbar-h));
      margin-top: var(--topbar-h);
    }
    .panel {position:relative; min-width:0; border-left:1px solid #2c3143;}
    .panel:first-child{border-left:none;}
    .panel[data-col="left"]   { flex: var(--w-left); }
    .panel[data-col="center"] { flex: var(--w-center); }
    .panel[data-col="right"]  { flex: var(--w-right); }

    /* å·¦ã‚«ãƒ©ãƒ ã‚’ä¸Šä¸‹ã«åˆ†å‰²ï¼ˆæ¯”ç‡ã‚’å³å®ˆï¼‰ */
    .panel[data-col="left"] .col-vert{ display:flex; flex-direction:column; height:100%; width:100%; }
    .subpanel[data-region="kyushu"]  { flex: var(--h-kyushu) 1 0; }
    .subpanel[data-region="okinawa"] { flex: var(--h-okinawa) 1 0; }

    .subpanel {position:relative; min-height:0; overflow:hidden;}
    .map {position:absolute; inset:0;}

    .title{
      position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
      text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4); letter-spacing:.05em;
    }
    .note{
      position:absolute; right:8px; bottom:6px; font-size:.8rem; opacity:.8; color:#cfd6ea;
    }

    /* èª¿æ•´ç”¨HUDï¼ˆ?edit=1 ã®ã¨ãã ã‘è¡¨ç¤ºï¼‰ */
    .hud{
      display:none; position:absolute; right:8px; top:6px; z-index:20;
      background:rgba(0,0,0,.35); color:#fff; padding:6px 8px; border-radius:8px;
      font-size:12px; line-height:1.4; box-shadow:0 4px 14px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }
    .hud .row{white-space:nowrap}
    .hud button{
      margin-left:6px; padding:2px 6px; border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.1); color:#fff; border-radius:6px; cursor:pointer;
    }
    .is-edit .hud{display:block;}

    /* ã‚¿ã‚¤ãƒ«ã®è¦‹ãŸç›®å¾®èª¿æ•´ */
    .relief-overlay { mix-blend-mode: multiply; }
    .base-tiles{ filter: brightness(1.05) contrast(0.85) saturate(0.75) opacity(0.95); }

    /* å¤©æ°—ãƒ©ãƒ™ãƒ«ï¼ˆã‚¢ã‚¤ã‚³ãƒ³å¤§ã€æ¸©åº¦ã¯åˆ¥ã‚µã‚¤ã‚ºï¼‰ */
    .wx-label{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:700; font-size:16px; color:#fff; pointer-events:none;
      text-shadow:0 0 2px rgba(0,0,0,.65),0 0 4px rgba(0,0,0,.35);
    }
    .wx-label .wx-emoji{
      font-size: calc(1em * var(--emoji-scale));
      line-height: 1; filter: drop-shadow(0 0 2px rgba(0,0,0,.45));
    }
    .wx-label .wx-temp{
      font-size: calc(1em * var(--temp-scale));
      font-weight: 800;
    }
    .wx-emoji-img{
      width: calc(20px * var(--emoji-scale)); height:auto; vertical-align: middle;
      filter: drop-shadow(0 0 2px rgba(0,0,0,.5));
    }
  </style>
</head>
<body>
  <!-- ä¸Šéƒ¨å¸¯ -->
  <div class="topbar">
    <div class="topbar__title">å…¨å›½ã®ãŠå¤©æ°—</div>
    <div class="topbar__meta" id="tb-time">æ›´æ–°: --/-- --:--</div>
  </div>

  <!-- 3åˆ†å‰²ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="wrap">
    <!-- å·¦ï¼šä¹å·ï¼ˆä¸Šï¼‰ï¼‹æ²–ç¸„ï¼ˆä¸‹ï¼‰ -->
    <div class="panel" data-col="left">
      <div class="col-vert">
        <div class="subpanel" data-region="kyushu">
          <div class="title">ä¹å·</div>
          <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
          <div id="map-kyushu" class="map"></div>
        </div>
        <div class="subpanel" data-region="okinawa">
          <div class="title">æ²–ç¸„</div>
          <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
          <div id="map-okinawa" class="map"></div>
        </div>
      </div>
    </div>

    <!-- ä¸­å¤®ï¼šæœ¬å· -->
    <div class="panel" data-col="center" data-region="honshu">
      <div class="title">æœ¬å·</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-honshu" class="map"></div>
    </div>

    <!-- å³ï¼šåŒ—æµ·é“ -->
    <div class="panel" data-col="right" data-region="hokkaido">
      <div class="title">åŒ—æµ·é“</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-hokkaido" class="map"></div>
    </div>
  </div>

  <div class="note">åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ« / ãƒ‡ãƒ¼ã‚¿: Open-Meteo</div>

  <script>
  // ===== ã‚¿ã‚¤ãƒ«å®šç¾© =====
  const BASE_TILE   = 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png';   // æ·¡è‰²
  const RELIEF_TILE = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png'; // æ¨™é«˜
  const RELIEF_OPACITY = 0.45;
  const ATTR = '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>';

  const urlp = new URLSearchParams(location.search);
  const IS_EDIT = urlp.get('edit') === '1';
  if (IS_EDIT) document.body.classList.add('is-edit');

  const USE_FIXED_VIEW = true; // ã‚µã‚¤ãƒãƒ¼ã‚¸ã§ã¯å›ºå®šè¡¨ç¤º

  // ä¸Šéƒ¨å¸¯ã®æ™‚åˆ»è¡¨ç¤º
  function updateTopbarTime(){
    const el = document.getElementById('tb-time');
    if(!el) return;
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    el.textContent = `æ›´æ–°: ${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  updateTopbarTime();
  setInterval(updateTopbarTime, 60*1000);

  // å›ºå®šãƒ“ãƒ¥ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
  const PANEL_VIEW = {
    kyushu:   { center: [32.53711, 130.77553], zoom: 7 },
    okinawa:  { center: [26.40581, 128.12886], zoom: 7 },
    honshu:   { center: [37.04665, 137.07624], zoom: 6 },
    hokkaido: { center: [41.76261, 142.96465], zoom: 6 },
  };

  // è‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆã®ä¿é™ºï¼ˆå›ºå®šã‚’ä½¿ã‚ãªã„æ™‚ã ã‘å‚ç…§ï¼‰
  const REGION_BOUNDS = {
    kyushu:   [[30.0, 128.0], [34.5, 132.8]],
    okinawa:  [[24.0, 122.5], [27.8, 129.8]],
    honshu:   [[33.0, 130.0], [41.9, 142.5]],
    hokkaido: [[41.2, 139.0], [45.9, 146.5]],
  };
  const REGION_ZOOM_MAX = { kyushu:7, okinawa:10, honshu:6, hokkaido:6 };

  // ===== è¡¨ç¤ºåœ°ç‚¹ï¼ˆã”æŒ‡å®šåˆ†ã‚’ã™ã¹ã¦å«ã‚€ï¼‰ =====
  const PLACES = [
    // ä¹å·
    { id:"fukuoka",   name:"ç¦å²¡å¸‚",   pref:"ç¦å²¡çœŒ",   lat:33.58333, lon:130.39999 },
    { id:"kumamoto",  name:"ç†Šæœ¬å¸‚",   pref:"ç†Šæœ¬çœŒ",   lat:32.80310, lon:130.70790 },
    { id:"nagasaki",  name:"é•·å´å¸‚",   pref:"é•·å´çœŒ",   lat:32.75030, lon:129.87770 },
    { id:"oita",      name:"å¤§åˆ†å¸‚",   pref:"å¤§åˆ†çœŒ",   lat:33.23960, lon:131.60930 },
    { id:"miyazaki",  name:"å®®å´å¸‚",   pref:"å®®å´çœŒ",   lat:31.90778, lon:131.42028 },
    { id:"kagoshima", name:"é¹¿å…å³¶å¸‚", pref:"é¹¿å…å³¶çœŒ", lat:31.56670, lon:130.55000 },

    // æ²–ç¸„
    { id:"naha",      name:"é‚£è¦‡å¸‚",   pref:"æ²–ç¸„çœŒ",   lat:26.21240, lon:127.68093 },

    // æœ¬å·ï¼ˆå››å›½å«ã‚€ï¼‰
    { id:"akita",     name:"ç§‹ç”°å¸‚",   pref:"ç§‹ç”°çœŒ",   lat:39.72000, lon:140.10350 },
    { id:"ishikawa",  name:"é‡‘æ²¢å¸‚",   pref:"çŸ³å·çœŒ",   lat:36.56130, lon:136.65620 },
    { id:"shizuoka",  name:"é™å²¡å¸‚",   pref:"é™å²¡çœŒ",   lat:34.97560, lon:138.38280 },
    { id:"okayama",   name:"å²¡å±±å¸‚",   pref:"å²¡å±±çœŒ",   lat:34.65500, lon:133.91950 },
    { id:"yamaguchi", name:"å±±å£å¸‚",   pref:"å±±å£çœŒ",   lat:34.17830, lon:131.47360 },

    { id:"osaka",     name:"å¤§é˜ªå¸‚",   pref:"å¤§é˜ªåºœ",   lat:34.69374, lon:135.50217 },
    { id:"nagoya",    name:"åå¤å±‹å¸‚", pref:"æ„›çŸ¥çœŒ",   lat:35.18145, lon:136.90640 },
    { id:"hiroshima", name:"åºƒå³¶å¸‚",   pref:"åºƒå³¶çœŒ",   lat:34.39161, lon:132.45182 },
    { id:"niigata",   name:"æ–°æ½Ÿå¸‚",   pref:"æ–°æ½ŸçœŒ",   lat:37.91611, lon:139.03639 },
    { id:"morioka",   name:"ç››å²¡å¸‚",   pref:"å²©æ‰‹çœŒ",   lat:39.70000, lon:141.15000 },
    { id:"sendai",    name:"ä»™å°å¸‚",   pref:"å®®åŸçœŒ",   lat:38.26884, lon:140.87194 },
    { id:"chiyoda",   name:"åƒä»£ç”°",   pref:"æ±äº¬éƒ½",   lat:35.69000, lon:139.76000 },

    // åŒ—æµ·é“
    { id:"sapporo",   name:"æœ­å¹Œå¸‚",   pref:"åŒ—æµ·é“",   lat:43.06417, lon:141.34694 },
    { id:"hakodate",  name:"å‡½é¤¨å¸‚",   pref:"åŒ—æµ·é“",   lat:41.76870, lon:140.72880 },
    { id:"wakkanai",  name:"ç¨šå†…å¸‚",   pref:"åŒ—æµ·é“",   lat:45.41560, lon:141.67300 },
    { id:"abashiri",  name:"ç¶²èµ°å¸‚",   pref:"åŒ—æµ·é“",   lat:44.02000, lon:144.26970 },
    { id:"kushiro",   name:"é‡§è·¯å¸‚",   pref:"åŒ—æµ·é“",   lat:42.98490, lon:144.38190 },
    { id:"furano",    name:"å¯Œè‰¯é‡å¸‚", pref:"åŒ—æµ·é“",   lat:43.34200, lon:142.38300 },
  ];

  // === ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šï¼ˆçµµæ–‡å­—ã‚’å¤§ãã / ç”»åƒã«å·®ã—æ›¿ãˆå¯ï¼‰ ===
  const USE_IMAGE_ICONS = false;       // ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã†ãªã‚‰ true
  const ICON_BASE = "icons";           // icons/clear.svg ãªã©ã‚’é…ç½®

  function codeToName(wc){
    if ([0].includes(wc)) return "clear";
    if ([1,2].includes(wc)) return "partly";
    if ([3].includes(wc))  return "cloudy";
    if ([45,48].includes(wc)) return "fog";
    if ([51,53,55,61,63,65].includes(wc)) return "rain";
    if ([71,73,75].includes(wc)) return "snow";
    if ([95,96,99].includes(wc)) return "thunder";
    return "partly";
  }
  function iconTagFor(wc){
    if (USE_IMAGE_ICONS){
      const name = codeToName(wc);
      return `<img class="wx-emoji-img" src="${ICON_BASE}/${name}.svg" alt="">`;
    }
    return `<span class="wx-emoji">${wcToEmoji(wc)}</span>`;
  }
  function labelHTML(wc, temp){
    const icon = iconTagFor(wc);
    const t = (typeof temp === "number") ? `<span class="wx-temp">${Math.round(temp)}â„ƒ</span>` : "";
    return `${icon}${t}`;
  }
  function makeDivIcon(html){
    return L.divIcon({ className:"wx-label", html, iconSize:null, iconAnchor:[0,0] });
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  async function loadJSON(id){
    try{
      const res = await fetch(`data/${id}.json?ts=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) return null;
      return await res.json();
    }catch{ return null; }
  }
  function wcToEmoji(wc){
    return ({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",
             61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"})[wc] ?? "â›…";
  }
  function subset(region){
    if(region==="kyushu")   return PLACES.filter(p => ["ç¦å²¡çœŒ","ç†Šæœ¬çœŒ","é•·å´çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref));
    if(region==="okinawa")  return PLACES.filter(p => p.pref==="æ²–ç¸„çœŒ");
    if(region==="hokkaido") return PLACES.filter(p => p.pref==="åŒ—æµ·é“");
    return PLACES.filter(p => !["åŒ—æµ·é“","æ²–ç¸„çœŒ","ç¦å²¡çœŒ","ç†Šæœ¬çœŒ","é•·å´çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref)); // æœ¬å·
  }

  // ===== ãƒãƒƒãƒ—ç”Ÿæˆ =====
  async function buildMap(elId, regionKey){
    const holder = document.querySelector(`[data-region="${regionKey}"]`) || document.querySelector(`[id="${elId}"]`)?.parentElement;
    const map = L.map(elId, {
      zoomControl: IS_EDIT, attributionControl:false,
      dragging: IS_EDIT, scrollWheelZoom: IS_EDIT, doubleClickZoom: IS_EDIT,
      touchZoom: IS_EDIT, boxZoom: IS_EDIT, keyboard: IS_EDIT
    });

    // ãƒ™ãƒ¼ã‚¹ï¼‹æ¨™é«˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    L.tileLayer(BASE_TILE,   { attribution: ATTR, maxZoom: 18, className:'base-tiles' }).addTo(map);
    L.tileLayer(RELIEF_TILE, { attribution: ATTR, maxZoom: 18, opacity: RELIEF_OPACITY, className:'relief-overlay' }).addTo(map);

    if (USE_FIXED_VIEW && PANEL_VIEW[regionKey]){
      map.setView(PANEL_VIEW[regionKey].center, PANEL_VIEW[regionKey].zoom);
    } else {
      setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(REGION_BOUNDS[regionKey], { padding:[16,16] });
        const zmax = REGION_ZOOM_MAX[regionKey] ?? map.getZoom();
        if (map.getZoom() > zmax) map.setZoom(zmax);
      }, 0);
    }

    // ãƒ©ãƒ™ãƒ«
    for(const p of subset(regionKey)){
      const j  = await loadJSON(p.id);
      const t  = j?.current?.temperature_2m;
      const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
      const html = (typeof t === "number") ? labelHTML(wc, t) : `<span class="wx-temp">${p.name}</span>`;
      L.marker([p.lat,p.lon], { icon: makeDivIcon(html) }).addTo(map);
    }

    // HUDï¼ˆedit=1ï¼‰
    const hud = holder?.querySelector('.hud');
    if (IS_EDIT && hud){
      const latEl = hud.querySelector('.lat'), lonEl = hud.querySelector('.lon'), zEl = hud.querySelector('.z');
      const btn = hud.querySelector('.copy');
      const upd = () => { const c = map.getCenter(); latEl.textContent=c.lat.toFixed(5); lonEl.textContent=c.lng.toFixed(5); zEl.textContent=map.getZoom().toFixed(0); };
      map.on('moveend zoomend', upd); upd();
      btn.addEventListener('click', async () => {
        const c = map.getCenter(), z = map.getZoom();
        const snippet = `  ${regionKey}: { center: [${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}], zoom: ${z} },`;
        try { await navigator.clipboard.writeText(snippet); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',1500); }
        catch { alert(snippet); }
      });
    }

    setTimeout(()=>map.invalidateSize(true),0);
    return map;
  }

  // ===== åˆæœŸåŒ– =====
  window.addEventListener("load", async () => {
    await Promise.all([
      buildMap("map-kyushu",   "kyushu"),
      buildMap("map-okinawa",  "okinawa"),
      buildMap("map-honshu",   "honshu"),
      buildMap("map-hokkaido", "hokkaido"),
    ]);
    if (!IS_EDIT) {
      setInterval(() => {
        const base = location.href.split("#")[0].split("?")[0];
        location.replace(`${base}?v=${Date.now()}`); // 10åˆ†ã”ã¨ã«ãƒªãƒ­ãƒ¼ãƒ‰
      }, 10*60*1000);
    }
  });
  </script>
</body>
</html>
