<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤©æ°—ãƒãƒƒãƒ—ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ / èƒŒæ™¯ãƒã‚¹ã‚¯ãªã—ãƒ»ã‚¯ãƒ©ã‚¹ã‚¿å¯¾å¿œï¼‰</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- MarkerCluster -->
  <link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet" />
  <link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html,body,#map { height: 100%; margin: 0; background: #0b1220; color: #eaeef5;
      font-family: system-ui, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    .leaflet-popup-content { margin: 10px 12px; }
    .footer { position: fixed; left: 0; right: 0; bottom: 0;
      padding: 6px 10px; font-size: .8rem; opacity: .85; background: rgba(0,0,0,.25); }
    /* èƒŒæ™¯ãƒã‚¹ã‚¯ãªã—ãƒ»ã‚µã‚¤ã‚ºçµ±ä¸€ã®ãƒ©ãƒ™ãƒ« */
    .wx-label {
      font-weight: 700; font-size: 16px; line-height: 1; white-space: nowrap; pointer-events: none;
      color: #ffffff;
      /* æ§ãˆã‚ãªç¸å–ã‚Šã ã‘ã§è¦–èªæ€§ã‚’ç¢ºä¿ */
      text-shadow:
        0 0 2px rgba(0,0,0,.65),
        0 0 4px rgba(0,0,0,.35);
    }
    /* ã‚¿ãƒƒãƒç«¯æœ«ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆã«ã—ãŸã„å ´åˆã¯ä¸‹ã‚’æœ‰åŠ¹åŒ–
    .leaflet-container { touch-action: pan-x pan-y; }
    */
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="footer">ãƒ‡ãƒ¼ã‚¿: Open-Meteo / åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆå‡ºå…¸ï¼šå›½åœŸåœ°ç†é™¢ï¼‰</div>

  <script>
    // === è¡¨ç¤ºã™ã‚‹åœ°ç‚¹ï¼ˆNarita â†’ Kisarazu ã«å·®ã—æ›¿ãˆ + è¿½åŠ éƒ½å¸‚ï¼‰ ===
    const PLACES = [
      { id: "kisarazu", name: "æœ¨æ›´æ´¥å¸‚", lat: 35.3761,  lon: 139.917   },
      { id: "nagoya",   name: "åå¤å±‹å¸‚", lat: 35.18145, lon: 136.90640 },
      { id: "osaka",    name: "å¤§é˜ªå¸‚",   lat: 34.69374, lon: 135.50217 },
      { id: "hiroshima",name: "åºƒå³¶å¸‚",   lat: 34.39161, lon: 132.45182 },
      { id: "fukuoka",  name: "ç¦å²¡å¸‚",   lat: 33.58333, lon: 130.39999 },
      { id: "morioka",  name: "ç››å²¡å¸‚",   lat: 39.70000, lon: 141.15000 },
      { id: "hakodate", name: "å‡½é¤¨å¸‚",   lat: 41.76861, lon: 140.72889 },
      { id: "niigata",  name: "æ–°æ½Ÿå¸‚",   lat: 37.91611, lon: 139.03639 },
      { id: "toyama",   name: "å¯Œå±±å¸‚",   lat: 36.69592, lon: 137.21369 },
      { id: "miyazaki", name: "å®®å´å¸‚",   lat: 31.90778, lon: 131.42028 },
      { id: "kagoshima",name: "é¹¿å…å³¶å¸‚", lat: 31.56670, lon: 130.55000 },
      // æ—¢å­˜åˆ†ï¼ˆä¾‹ï¼‰
      { id: "chiyoda",  name: "åƒä»£ç”°",   lat: 35.69000, lon: 139.76000 },
      { id: "sendai",   name: "ä»™å°å¸‚",   lat: 38.26884, lon: 140.87194 },
    ];

    // === åœ°å›³åˆæœŸåŒ– ===
    const map = L.map('map', { zoomControl: true }).setView([36.2, 139.7], 6);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>'
    }).addTo(map);

    // === ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¬ã‚¤ãƒ¤ ===
    const cluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 8, // 8ä»¥ä¸Šã§å€‹åˆ¥è¡¨ç¤º
      maxClusterRadius: 55        // é‡ãªã‚ŠãŒå¼·ã„å ´åˆã¯æ•°å€¤ã‚’å¤§ãã
    });
    map.addLayer(cluster);

    // === èƒŒæ™¯ãªã—ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ« ===
    function iconText(text) {
      return L.divIcon({
        className: "wx-label",
        html: text,      // ä¾‹: "â˜€ 28â„ƒ"
        iconSize: null,  // ãƒ†ã‚­ã‚¹ãƒˆå¹…ã«ãƒ•ã‚£ãƒƒãƒˆ
        iconAnchor: [0, 0] // å·¦ä¸ŠåŸºæº–ï¼ˆé‡ãªã‚Šã‚’å°‘ã—å›é¿ï¼‰
      });
    }

    // === JSON ãƒ­ãƒ¼ãƒ€ ===
    async function loadJSON(id) {
      const url = `data/${id}.json?ts=${Date.now()}`; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    // === å¤©æ°—ã‚³ãƒ¼ãƒ‰ â†’ çµµæ–‡å­—ï¼ˆç°¡æ˜“ï¼‰ ===
    function wcToEmoji(wc) {
      return ({
        0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",
        45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",
        61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",
        71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",
        95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"
      })[wc] ?? "â›…";
    }

    // === æç”» ===
    async function render() {
      cluster.clearLayers();

      for (const p of PLACES) {
        try {
          const j = await loadJSON(p.id);
          const c = j.current || {};
          const d = j.daily   || {};
          const t  = (c.temperature_2m != null) ? Math.round(c.temperature_2m) : "-";
          const tH = (d.temperature_2m_max?.[0] != null) ? Math.round(d.temperature_2m_max[0]) : "-";
          const tL = (d.temperature_2m_min?.[0] != null) ? Math.round(d.temperature_2m_min[0]) : "-";
          const emo= wcToEmoji(c.weather_code ?? d.weather_code?.[0]);

          const m = L.marker([p.lat, p.lon], { icon: iconText(`${emo} ${t}â„ƒ`) });
          const upd = j.updatedAt ? new Date(j.updatedAt).toLocaleString("ja-JP") : "";
          m.bindPopup(`
            <div style="line-height:1.4">
              <div><b>${p.name}</b></div>
              <div>ç¾åœ¨ ${t}â„ƒ / â†‘${tH}â„ƒ / â†“${tL}â„ƒ</div>
              <div style="opacity:.8">æœ€çµ‚æ›´æ–°: ${upd}</div>
            </div>
          `);
          cluster.addLayer(m);
        } catch (e) {
          const m = L.marker([p.lat, p.lon], { icon: iconText("N/A") });
          m.bindPopup(`
            <div style="line-height:1.4">
              <div><b>${p.name}</b></div>
              <div>JSONèª­ã¿è¾¼ã¿å¤±æ•—</div>
              <div style="opacity:.8">${String(e).slice(0, 100)}</div>
            </div>
          `);
          cluster.addLayer(m);
        }
      }
    }

    render();

    // 10åˆ†ã”ã¨ã«è‡ªå·±ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆYodeckå´ã®æ›´æ–°è¨­å®šã«åŠ ãˆã¦ä¿é™ºï¼‰
    setInterval(() => {
      const base = location.href.split("#")[0].split("?")[0];
      location.replace(`${base}?v=${Date.now()}`);
    }, 10 * 60 * 1000);
  </script>
</body>
</html>
