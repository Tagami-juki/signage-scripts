<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å…¨å›½ã®ãŠå¤©æ°—ï½œ3åˆ†å‰²ï¼‹ä¹å·/æ²–ç¸„ï¼ˆ7:3ï¼‰ï¼‹æ¦‚æ³ãƒ†ã‚£ãƒƒã‚«ãƒ¼</title>

<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html,body {height:100%; margin:0; background:#0b1220; color:#fff;}

  :root{
    --topbar-h: 64px;
    --w-left:   0.7; --w-center: 1.5; --w-right: 0.7;
    --h-kyushu: 7;   --h-okinawa: 3;

    --emoji-scale: 2.2; --temp-scale: 1.6;
    --temp-stroke: 3px; --temp-stroke-color: rgba(0,0,0,.9);
  }

  /* ===== Top bar ===== */
  .topbar{
    position: fixed; left:0; right:0; top:0; height: var(--topbar-h);
    display:flex; align-items:center; gap:14px;
    padding: 0 16px;
    background: rgba(11,18,32,.75);
    color:#fff; z-index:999;
    backdrop-filter: blur(6px);
    box-shadow: 0 2px 12px rgba(0,0,0,.35);
  }
  .topbar__title{
    flex: 0 0 auto;
    font-weight:900; font-size:26px; letter-spacing:.04em;
    text-shadow: 0 2px 6px rgba(0,0,0,.45);
    white-space:nowrap;
  }
  .topbar__ticker{
    flex: 1 1 auto; overflow:hidden; min-width: 30%;
    position: relative;
  }
  .ticker__track{
    display:inline-block; white-space:nowrap; will-change: transform;
    animation: ticker 28s linear infinite;
  }
  .topbar__ticker:hover .ticker__track{ animation-play-state: paused; }
  @keyframes ticker{
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); } /* ãƒ†ã‚­ã‚¹ãƒˆã‚’2å›é€£çµã—ã¦ç„¡é™ãƒ«ãƒ¼ãƒ— */
  }
  .ticker__text{ opacity:.96; text-shadow: 0 1px 4px rgba(0,0,0,.25); }
  .topbar__meta{ flex: 0 0 auto; font-size:14px; opacity:.9; white-space:nowrap; }

  /* ===== layout ===== */
  .wrap{ display:flex; width:100vw; height: calc(100vh - var(--topbar-h)); margin-top: var(--topbar-h); }
  .panel {position:relative; min-width:0; border-left:1px solid #2c3143;}
  .panel:first-child{border-left:none;}
  .panel[data-col="left"]   { flex: var(--w-left); }
  .panel[data-col="center"] { flex: var(--w-center); }
  .panel[data-col="right"]  { flex: var(--w-right); }

  .panel[data-col="left"] .col-vert{ display:flex; flex-direction:column; height:100%; width:100%; }
  .subpanel[data-region="kyushu"]  { flex: var(--h-kyushu) 1 0; }
  .subpanel[data-region="okinawa"] { flex: var(--h-okinawa) 1 0; }
  .subpanel {position:relative; min-height:0; overflow:hidden;}
  .map {position:absolute; inset:0;}

  .title{
    position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
    text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4); letter-spacing:.05em;
  }
  .note{ position:absolute; right:8px; bottom:6px; font-size:.8rem; opacity:.8; color:#cfd6ea; }

  .hud{ display:none; position:absolute; right:8px; top:6px; z-index:20;
        background:rgba(0,0,0,.35); color:#fff; padding:6px 8px; border-radius:8px;
        font-size:12px; line-height:1.4; box-shadow:0 4px 14px rgba(0,0,0,.25); backdrop-filter: blur(2px);}
  .hud .row{white-space:nowrap} .hud button{ margin-left:6px; padding:2px 6px;
    border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.1); color:#fff; border-radius:6px; cursor:pointer;}
  .is-edit .hud{display:block;}

  .relief-overlay { mix-blend-mode: multiply; }
  .base-tiles{ filter: brightness(1.05) contrast(0.85) saturate(0.75) opacity(0.95); }

  .wx-label{ display:inline-flex; flex-direction: column; align-items:center; gap:1px;
             font-weight:700; font-size:16px; color:#fff; pointer-events:none; }
  .wx-label .wx-emoji{ font-size: calc(1em * var(--emoji-scale)); line-height:1; filter: drop-shadow(0 0 2px rgba(0,0,0,.45)); }
  .wx-label .wx-temp{
    font-size: calc(1em * var(--temp-scale));
    font-weight: 800;
    color:#fff;
    -webkit-text-stroke: var(--temp-stroke) var(--temp-stroke-color);
    
    text-shadow: 0 0 2px rgba(0,0,0,.35),
  }
  .wx-emoji-img{ width: calc(20px * var(--emoji-scale)); height:auto; vertical-align: middle;
                 filter: drop-shadow(0 0 2px rgba(0,0,0,.5)); }
  @media (prefers-reduced-motion: reduce){
    .ticker__track{ animation: none !important; }
  }
</style>
</head>
<body>
  <!-- ===== Top bar ===== -->
  <div class="topbar">
    <div class="topbar__title">å…¨å›½ã®ãŠå¤©æ°—</div>
    <!-- â–¼ æ¦‚æ³ãƒ†ã‚£ãƒƒã‚«ãƒ¼ -->
    <div class="topbar__ticker">
      <div class="ticker__track" id="ticker-track">
        <span class="ticker__text" id="ticker-text">ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­â€¦</span>
        <span class="ticker__text" aria-hidden="true" id="ticker-dup">ã€€ï½œã€€</span>
      </div>
    </div>
    <!-- â–² -->
    <div class="topbar__meta" id="tb-time">æ›´æ–°: --/-- --:--</div>
  </div>

  <!-- ===== 3åˆ†å‰² ===== -->
  <div class="wrap">
    <div class="panel" data-col="left">
      <div class="col-vert">
        <div class="subpanel" data-region="kyushu">
          <div class="title">ä¹å·</div>
          <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
          <div id="map-kyushu" class="map"></div>
        </div>
        <div class="subpanel" data-region="okinawa">
          <div class="title">æ²–ç¸„</div>
          <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
          <div id="map-okinawa" class="map"></div>
        </div>
      </div>
    </div>

    <div class="panel" data-col="center" data-region="honshu">
      <div class="title">æœ¬å·</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-honshu" class="map"></div>
    </div>

    <div class="panel" data-col="right" data-region="hokkaido">
      <div class="title">åŒ—æµ·é“</div>
      <div class="hud"><div class="row">lat:<span class="lat"></span> lon:<span class="lon"></span> z:<span class="z"></span><button class="copy">Copy</button></div></div>
      <div id="map-hokkaido" class="map"></div>
    </div>
  </div>

  <div class="note">åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ« / ãƒ‡ãƒ¼ã‚¿: Open-Meteo</div>

<script>
/* ===== ã‚¿ã‚¤ãƒ« ===== */
const BASE_TILE   = 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png';
const RELIEF_TILE = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png';
const RELIEF_OPACITY = 0.45;
const ATTR = '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>';

const urlp = new URLSearchParams(location.search);
const IS_EDIT = urlp.get('edit') === '1';
if (IS_EDIT) document.body.classList.add('is-edit');

const USE_FIXED_VIEW = true;

/* ===== æ™‚åˆ»è¡¨ç¤º ===== */
function updateTopbarTime(){
  const el = document.getElementById('tb-time'); if(!el) return;
  const d = new Date(); const pad = n => String(n).padStart(2,'0');
  el.textContent = `æ›´æ–°: ${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
updateTopbarTime(); setInterval(updateTopbarTime, 60*1000);

/* ===== å›ºå®šãƒ“ãƒ¥ãƒ¼ ===== */
const PANEL_VIEW = {
  kyushu:   { center: [32.53711, 130.77553], zoom: 7.5 },
  okinawa:  { center: [26.26865, 128.18304], zoom: 8 },
  honshu:   { center: [37.04665, 137.07624], zoom: 7 },
  hokkaido: { center: [41.76261, 142.96465], zoom: 6.5 },
};
const REGION_BOUNDS = {
  kyushu:   [[30.0, 128.0], [34.5, 132.8]],
  okinawa:  [[24.0, 122.5], [27.8, 129.8]],
  honshu:   [[33.0, 130.0], [41.9, 142.5]],
  hokkaido: [[41.2, 139.0], [45.9, 146.5]],
};
const REGION_ZOOM_MAX = { kyushu:7, okinawa:10, honshu:6, hokkaido:6 };

/* ===== è¡¨ç¤ºåœ°ç‚¹ ===== */
const PLACES = [
  // ä¹å·
  { id:"fukuoka",   name:"ç¦å²¡å¸‚",   pref:"ç¦å²¡çœŒ",   lat:33.58333, lon:130.39999 },
  { id:"kumamoto",  name:"ç†Šæœ¬å¸‚",   pref:"ç†Šæœ¬çœŒ",   lat:32.80310, lon:130.70790 },
  { id:"nagasaki",  name:"é•·å´å¸‚",   pref:"é•·å´çœŒ",   lat:32.75030, lon:129.87770 },
  { id:"oita",      name:"å¤§åˆ†å¸‚",   pref:"å¤§åˆ†çœŒ",   lat:33.23960, lon:131.60930 },
  { id:"miyazaki",  name:"å®®å´å¸‚",   pref:"å®®å´çœŒ",   lat:31.90778, lon:131.42028 },
  { id:"kagoshima", name:"é¹¿å…å³¶å¸‚", pref:"é¹¿å…å³¶çœŒ", lat:31.56670, lon:130.55000 },
  // æ²–ç¸„
  { id:"naha",      name:"é‚£è¦‡å¸‚",   pref:"æ²–ç¸„çœŒ",   lat:26.21240, lon:127.68093 },
  // æœ¬å·
  { id:"akita",     name:"ç§‹ç”°å¸‚",   pref:"ç§‹ç”°çœŒ",   lat:39.72000, lon:140.10350 },
  { id:"ishikawa",  name:"é‡‘æ²¢å¸‚",   pref:"çŸ³å·çœŒ",   lat:36.56130, lon:136.65620 },
  { id:"shizuoka",  name:"é™å²¡å¸‚",   pref:"é™å²¡çœŒ",   lat:34.97560, lon:138.38280 },
  { id:"okayama",   name:"å²¡å±±å¸‚",   pref:"å²¡å±±çœŒ",   lat:34.65500, lon:133.91950 },
  { id:"osaka",     name:"å¤§é˜ªå¸‚",   pref:"å¤§é˜ªåºœ",   lat:34.69374, lon:135.50217 },
  { id:"nagoya",    name:"åå¤å±‹å¸‚", pref:"æ„›çŸ¥çœŒ",   lat:35.18145, lon:136.90640 },
  { id:"hiroshima", name:"åºƒå³¶å¸‚",   pref:"åºƒå³¶çœŒ",   lat:34.39161, lon:132.45182 },
  { id:"niigata",   name:"æ–°æ½Ÿå¸‚",   pref:"æ–°æ½ŸçœŒ",   lat:37.91611, lon:139.03639 },
  { id:"morioka",   name:"ç››å²¡å¸‚",   pref:"å²©æ‰‹çœŒ",   lat:39.70000, lon:141.15000 },
  { id:"sendai",    name:"ä»™å°å¸‚",   pref:"å®®åŸçœŒ",   lat:38.26884, lon:140.87194 },
  { id:"chiyoda",   name:"åƒä»£ç”°",   pref:"æ±äº¬éƒ½",   lat:35.69000, lon:139.76000 },
  // åŒ—æµ·é“
  { id:"sapporo",   name:"æœ­å¹Œå¸‚",   pref:"åŒ—æµ·é“",   lat:43.06417, lon:141.34694 },
  { id:"hakodate",  name:"å‡½é¤¨å¸‚",   pref:"åŒ—æµ·é“",   lat:41.76870, lon:140.72880 },
  { id:"wakkanai",  name:"ç¨šå†…å¸‚",   pref:"åŒ—æµ·é“",   lat:45.41560, lon:141.67300 },
  { id:"abashiri",  name:"ç¶²èµ°å¸‚",   pref:"åŒ—æµ·é“",   lat:44.02000, lon:144.26970 },
  { id:"kushiro",   name:"é‡§è·¯å¸‚",   pref:"åŒ—æµ·é“",   lat:42.98490, lon:144.38190 },
  { id:"furano",    name:"å¯Œè‰¯é‡å¸‚", pref:"åŒ—æµ·é“",   lat:43.34200, lon:142.38300 },
];

/* ===== ã‚¢ã‚¤ã‚³ãƒ³ ===== */
const USE_IMAGE_ICONS = true;
const ICON_BASE = "icons";
function codeToName(wc){
  if (wc===0) return "clear";
  if (wc===1) return "mostly_clear";
  if (wc===2) return "partly";
  if (wc===3) return "overcast";
  if ([45,48].includes(wc)) return "fog";
  if ([51,53,55,56,57].includes(wc)) return "drizzle";
  if ([61,80].includes(wc)) return "rain_light";
  if ([63,66,81].includes(wc)) return "rain";
  if ([65,67,82].includes(wc)) return "rain_heavy";
  if ([71,77,85].includes(wc)) return "snow_light";
  if ([73,86].includes(wc)) return "snow";
  if (wc===75) return "snow_heavy";
  if ([95,96,99].includes(wc)) return "thunder";
  return "partly";
}
function iconTagFor(wc){ return USE_IMAGE_ICONS
   ? `<img class="wx-emoji-img" src="${ICON_BASE}/${codeToName(wc)}.svg" alt="">`
   : `<span class="wx-emoji">${({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"})[wc] ?? "â›…"}</span>`; }
function labelHTML(wc, temp){
  const icon = iconTagFor(wc);
  const t = (typeof temp === "number") ? `<span class="wx-temp">${Math.round(temp)}â„ƒ</span>` : "";
  return `${icon}${t}`;
}
function makeDivIcon(html){
  return L.divIcon({ className:"wx-label", html, iconSize:null, iconAnchor:[0,0] });
}

/* ===== JSONèª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰ ===== */
const JSON_CACHE = new Map();
async function loadJSON(id){
  if (JSON_CACHE.has(id)) return JSON_CACHE.get(id);
  try{
    const res = await fetch(`data/${id}.json?ts=${Date.now()}`, { cache:"no-store" });
    if(!res.ok) return null;
    const j = await res.json();
    JSON_CACHE.set(id, j);
    return j;
  }catch{ return null; }
}

/* ===== åœ°åŸŸåŒºåˆ†ï¼ˆæ¦‚æ³ç”¨ï¼‰ ===== */
const PREF_TO_REGION = {
  "åŒ—æµ·é“":"åŒ—æ—¥æœ¬",
  "é’æ£®çœŒ":"åŒ—æ—¥æœ¬","å²©æ‰‹çœŒ":"åŒ—æ—¥æœ¬","å®®åŸçœŒ":"åŒ—æ—¥æœ¬","ç§‹ç”°çœŒ":"åŒ—æ—¥æœ¬","å±±å½¢çœŒ":"åŒ—æ—¥æœ¬","ç¦å³¶çœŒ":"åŒ—æ—¥æœ¬",
  "æ–°æ½ŸçœŒ":"æ±æ—¥æœ¬","å¯Œå±±çœŒ":"æ±æ—¥æœ¬","çŸ³å·çœŒ":"æ±æ—¥æœ¬","ç¦äº•çœŒ":"æ±æ—¥æœ¬","é•·é‡çœŒ":"æ±æ—¥æœ¬","å±±æ¢¨çœŒ":"æ±æ—¥æœ¬",
  "èŒ¨åŸçœŒ":"æ±æ—¥æœ¬","æ ƒæœ¨çœŒ":"æ±æ—¥æœ¬","ç¾¤é¦¬çœŒ":"æ±æ—¥æœ¬","åŸ¼ç‰çœŒ":"æ±æ—¥æœ¬","åƒè‘‰çœŒ":"æ±æ—¥æœ¬","æ±äº¬éƒ½":"æ±æ—¥æœ¬","ç¥å¥ˆå·çœŒ":"æ±æ—¥æœ¬",
  "é™å²¡çœŒ":"æ±æ—¥æœ¬","æ„›çŸ¥çœŒ":"æ±æ—¥æœ¬",
  "å²é˜œçœŒ":"è¥¿æ—¥æœ¬","ä¸‰é‡çœŒ":"è¥¿æ—¥æœ¬","æ»‹è³€çœŒ":"è¥¿æ—¥æœ¬","äº¬éƒ½åºœ":"è¥¿æ—¥æœ¬","å¤§é˜ªåºœ":"è¥¿æ—¥æœ¬","å…µåº«çœŒ":"è¥¿æ—¥æœ¬","å¥ˆè‰¯çœŒ":"è¥¿æ—¥æœ¬","å’Œæ­Œå±±çœŒ":"è¥¿æ—¥æœ¬",
  "é³¥å–çœŒ":"è¥¿æ—¥æœ¬","å³¶æ ¹çœŒ":"è¥¿æ—¥æœ¬","å²¡å±±çœŒ":"è¥¿æ—¥æœ¬","åºƒå³¶çœŒ":"è¥¿æ—¥æœ¬","å±±å£çœŒ":"è¥¿æ—¥æœ¬","å¾³å³¶çœŒ":"è¥¿æ—¥æœ¬","é¦™å·çœŒ":"è¥¿æ—¥æœ¬","æ„›åª›çœŒ":"è¥¿æ—¥æœ¬","é«˜çŸ¥çœŒ":"è¥¿æ—¥æœ¬",
  "ç¦å²¡çœŒ":"è¥¿æ—¥æœ¬","ä½è³€çœŒ":"è¥¿æ—¥æœ¬","é•·å´çœŒ":"è¥¿æ—¥æœ¬","ç†Šæœ¬çœŒ":"è¥¿æ—¥æœ¬","å¤§åˆ†çœŒ":"è¥¿æ—¥æœ¬","å®®å´çœŒ":"è¥¿æ—¥æœ¬","é¹¿å…å³¶çœŒ":"è¥¿æ—¥æœ¬",
  "æ²–ç¸„çœŒ":"æ²–ç¸„"
};
function wcCategory(wc){
  if ([95,96,99].includes(wc)) return "é›·";
  if ([71,73,75,77,85,86].includes(wc)) return "é›ª";
  if ([61,63,65,66,67,80,81,82,51,53,55,56,57].includes(wc)) return "é›¨";
  if (wc===0||wc===1||wc===2) return "æ™´";
  if (wc===3) return "æ›‡";
  if ([45,48].includes(wc)) return "éœ§";
  return "æ›‡";
}

/* ===== æ¦‚æ³ã®è‡ªå‹•ç”Ÿæˆ ===== */
async function buildAndRenderTicker(){
  // å…¨åœ°ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const points = [];
  for (const p of PLACES){
    const j = await loadJSON(p.id);
    const t = j?.current?.temperature_2m;
    const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
    if (typeof wc === "number"){
      points.push({pref:p.pref, name:p.name, region: PREF_TO_REGION[p.pref] ?? "æ±æ—¥æœ¬", temp: t, wc, cat: wcCategory(wc)});
    }
  }
  if (!points.length){ setTickerText("å…¨å›½æ¦‚æ³ï¼šãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­â€¦"); return; }

  // å…¨å›½ã®å‚¾å‘
  const tally = (arr) => arr.reduce((a,b)=> (a[b]=(a[b]||0)+1, a), {});
  const cats = tally(points.map(p=>p.cat));
  const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0]?.[0] ?? "æ™´";
  const nationalSent =
    topCat==="æ™´" ? "å…¨å›½çš„ã«æ™´ã‚Œé–“ãŒå‡ºã‚‹æ‰€ãŒå¤šã„ã§ã—ã‚‡ã†" :
    topCat==="æ›‡" ? "é›²ã®åºƒãŒã‚‹æ‰€ãŒå¤šã„è¦‹è¾¼ã¿ã§ã™" :
    topCat==="é›¨" ? "é›¨ã®é™ã‚‹æ‰€ãŒå¤šãã€æŠ˜ã‚ŠãŸãŸã¿å‚˜ãŒã‚ã‚‹ã¨å®‰å¿ƒã§ã™" :
    topCat==="é›ª" ? "é›ªã®é™ã‚‹æ‰€ãŒã‚ã‚‹ã§ã—ã‚‡ã†" :
    topCat==="é›·" ? "å¤§æ°—ã®çŠ¶æ…‹ãŒä¸å®‰å®šã§é›·é›¨ã«æ³¨æ„ãŒå¿…è¦ã§ã™" :
    "æ¦‚ã­æ›‡ã‚ŠãŒã¡ã®å¤©æ°—ã§ã—ã‚‡ã†";

  // åœ°åŸŸåˆ¥ã‚³ãƒ¡ãƒ³ãƒˆ
  const byRegion = { "åŒ—æ—¥æœ¬":[], "æ±æ—¥æœ¬":[], "è¥¿æ—¥æœ¬":[], "æ²–ç¸„":[] };
  for (const p of points){ (byRegion[p.region]??= []).push(p); }
  function regionTempRange(list){
    const temps = list.map(p=>p.temp).filter(v=>typeof v==="number");
    if(!temps.length) return null;
    return [Math.round(Math.min(...temps)), Math.round(Math.max(...temps))];
  }
  function pickRegionNote(rKey){
    const list = byRegion[rKey]||[];
    if(!list.length) return null;
    const cats = tally(list.map(p=>p.cat));
    const main = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0][0];
    if (main==="æ™´") return `${rKey}ã¯æ—¥å·®ã—ã®å±Šãæ‰€ãŒå¤šã„è¦‹è¾¼ã¿`;
    if (main==="æ›‡") return `${rKey}ã¯é›²ãŒå¤šãã‚¹ãƒƒã‚­ãƒªã—ãªã„å¤©æ°—`;
    if (main==="é›¨") return `${rKey}ã§ã¯ã«ã‚ã‹é›¨ã®å¯èƒ½æ€§ãŒã‚ã‚Šã€å¤–å‡ºæ™‚ã¯é›¨å…·ã‚’`;
    if (main==="é›ª") return `${rKey}ã§ã¯é›ªã®é™ã‚‹æ‰€ãŒã‚ã‚‹ã§ã—ã‚‡ã†`;
    if (main==="é›·") return `${rKey}ã¯é›·é›¨ã®æã‚Œã€‚æ€¥ãªå¤©æ°—ã®å¤‰åŒ–ã«æ³¨æ„`;
    return null;
  }
  const notes = ["åŒ—æ—¥æœ¬","æ±æ—¥æœ¬","è¥¿æ—¥æœ¬","æ²–ç¸„"].map(pickRegionNote).filter(Boolean);
  const rN = {
    "åŒ—æ—¥æœ¬": regionTempRange(byRegion["åŒ—æ—¥æœ¬"]||[]),
    "æ±æ—¥æœ¬": regionTempRange(byRegion["æ±æ—¥æœ¬"]||[]),
    "è¥¿æ—¥æœ¬": regionTempRange(byRegion["è¥¿æ—¥æœ¬"]||[]),
  };
  const tempSent = [ "è¥¿æ—¥æœ¬","æ±æ—¥æœ¬","åŒ—æ—¥æœ¬" ]
    .map(k => rN[k] ? `${k}ã§${rN[k][0]}ã€œ${rN[k][1]}â„ƒ` : null)
    .filter(Boolean).join("ã€");

  const synopsis =
    `å…¨å›½æ¦‚æ³ï¼š${nationalSent}ã€‚` +
    (notes.length ? notes.join("ã€‚")+"ã€‚" : "") +
    (tempSent ? `æœ€é«˜æ°—æ¸©ã¯${tempSent}ã®æ‰€ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚` : "");

  setTickerText(synopsis);
}

/* ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã«æ–‡å­—ã‚’æµã™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆé•·ã«å¿œã˜é€Ÿåº¦èª¿æ•´ï¼‰ */
function setTickerText(text){
  const main = document.getElementById('ticker-text');
  const dup  = document.getElementById('ticker-dup');
  const track= document.getElementById('ticker-track');
  if(!main||!dup||!track) return;

  main.textContent = `ã€€${text}ã€€`;
  dup.textContent  = `ã€€ï½œã€€${text}ã€€`; // 2æœ¬ç›®ï¼ˆç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰

  // å¹…ã‹ã‚‰ã‚¢ãƒ‹ãƒ¡æ™‚é–“ã‚’è‡ªå‹•èª¿æ•´ï¼ˆæœ€å°20sï¼‰
  requestAnimationFrame(()=>{
    const w = main.getBoundingClientRect().width;
    const vw = Math.max(800, window.innerWidth);
    const sec = Math.max(20, (w*2) / (vw*0.06)); // ä¿‚æ•°ã¯ä½“æ„Ÿã§èª¿æ•´
    track.style.animationDuration = `${sec}s`;
  });
}

/* ===== ãƒãƒƒãƒ—ç”Ÿæˆ ===== */
async function buildMap(elId, regionKey){
  const holder = document.querySelector(`[data-region="${regionKey}"]`) || document.querySelector(`[id="${elId}"]`)?.parentElement;
  const map = L.map(elId, {
    zoomControl: IS_EDIT,
    attributionControl:false,
    zoomSnap: 0.25,   // â† 0.25åˆ»ã¿ï¼ˆ0ãªã‚‰ä»»æ„ã®å°æ•°OKï¼‰
    zoomDelta: 0.25,  // ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œã®åˆ»ã¿ã‚‚åˆã‚ã›ã¦0.25ã«
    dragging: IS_EDIT, scrollWheelZoom: IS_EDIT, doubleClickZoom: IS_EDIT,
    touchZoom: IS_EDIT, boxZoom: IS_EDIT, keyboard: IS_EDIT
  });
  L.tileLayer(BASE_TILE, {
    attribution: ATTR,
    maxZoom: 18,
    className: 'base-tiles',
    detectRetina: true
  }).addTo(map);
  
  L.tileLayer(RELIEF_TILE,{
  attribution: ATTR,
  maxZoom: 18,
  opacity: RELIEF_OPACITY,
  className: 'relief-overlay', 
  detectRetina: true
  }).addTo(map);

  if (USE_FIXED_VIEW && PANEL_VIEW[regionKey]){
    map.setView(PANEL_VIEW[regionKey].center, PANEL_VIEW[regionKey].zoom);
  } else {
    setTimeout(() => {
      map.invalidateSize(true);
      map.fitBounds(REGION_BOUNDS[regionKey], { padding:[16,16] });
      const zmax = REGION_ZOOM_MAX[regionKey] ?? map.getZoom();
      if (map.getZoom() > zmax) map.setZoom(zmax);
    }, 0);
  }

  // ãƒ©ãƒ™ãƒ«
  for(const p of PLACES){
    const inThis =
      (regionKey==="kyushu"  && ["ç¦å²¡çœŒ","ç†Šæœ¬çœŒ","é•·å´çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref)) ||
      (regionKey==="okinawa" && p.pref==="æ²–ç¸„çœŒ") ||
      (regionKey==="hokkaido"&& p.pref==="åŒ—æµ·é“") ||
      (regionKey==="honshu"  && !["æ²–ç¸„çœŒ","åŒ—æµ·é“","ç¦å²¡çœŒ","ç†Šæœ¬çœŒ","é•·å´çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref));
    if(!inThis) continue;

    const j  = await loadJSON(p.id);
    const t  = j?.current?.temperature_2m;
    const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
    const html = (typeof t === "number") ? labelHTML(wc, t) : `<span class="wx-temp">${p.name}</span>`;
    L.marker([p.lat,p.lon], { icon: makeDivIcon(html) }).addTo(map);
  }

  // HUD
  const hud = holder?.querySelector('.hud');
  if (IS_EDIT && hud){
    const latEl = hud.querySelector('.lat'), lonEl = hud.querySelector('.lon'), zEl = hud.querySelector('.z');
    const btn = hud.querySelector('.copy');
    const upd = () => { const c = map.getCenter(); latEl.textContent=c.lat.toFixed(5); lonEl.textContent=c.lng.toFixed(5); zEl.textContent=map.getZoom().toFixed(0); };
    map.on('moveend zoomend', upd); upd();
    btn.addEventListener('click', async () => {
      const c = map.getCenter(), z = map.getZoom();
      const snippet = `  ${regionKey}: { center: [${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}], zoom: ${z} },`;
      try { await navigator.clipboard.writeText(snippet); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',1500); }
      catch { alert(snippet); }
    });
  }

  setTimeout(()=>map.invalidateSize(true),0);
  return map;
}

/* ===== åˆæœŸåŒ– ===== */
window.addEventListener("load", async () => {
    // ã©ã‚Œã‹1é¢ã§å¤±æ•—ã—ã¦ã‚‚ä»–ã¯å‡ºã™
  const safeBuild = (id, key) =>
    buildMap(id, key).catch(err => console.error('map error', key, err));
  
  safeBuild("map-kyushu","kyushu");
  safeBuild("map-okinawa","okinawa");
  safeBuild("map-honshu","honshu");
  safeBuild("map-hokkaido","hokkaido");

  // ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã¯ â€œå¾…ãŸãªã„ãƒ»è½ã¨ã•ãªã„â€
  if (typeof loadKantoTicker === "function") {
    try { await loadKantoTicker(); }
    catch { setTickerText("ã€é–¢æ±ã®å¤©æ°—æ¦‚æ³ã€‘ ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­â€¦"); }
  }

  // æ¦‚æ³ãƒ†ã‚£ãƒƒã‚«ãƒ¼
  await buildAndRenderTicker();

  // å®šæœŸæ›´æ–°ï¼ˆ10åˆ†æ¯ / è¡¨ç¤ºä¸­ã®ã¿ï¼‰
  if (!IS_EDIT) {
    setInterval(() => {
      const base = location.href.split("#")[0].split("?")[0];
      location.replace(`${base}?v=${Date.now()}`);
    }, 10*60*1000);
  }
});
</script>
</body>
</html>
