<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å…¨å›½å¤©æ°—3åˆ†å‰²ãƒãƒƒãƒ—ï¼ˆå›ºå®šç¯„å›²ãƒ»å®‰å®šç‰ˆï¼‰</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body {height:100%; margin:0; background:#0b1220;}
    .wrap {display:flex; height:100vh; width:100vw;}
    .panel {flex:1; border-left:1px solid #2c3143; position:relative; min-width:0;}
    .panel:first-child {border-left:none;}
    .map {position:absolute; inset:0;}
    .title{
      position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
      text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4); letter-spacing:.05em;
    }
    .wx-label{
      font-weight:700; font-size:16px; color:#fff; pointer-events:none;
      text-shadow:0 0 2px rgba(0,0,0,.65),0 0 4px rgba(0,0,0,.35);
    }
    .note{
      position:absolute; right:8px; bottom:6px; font-size:.8rem; opacity:.8; color:#cfd6ea;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel"><div class="title">ä¹å·ãƒ»æ²–ç¸„</div><div id="map-kyushu" class="map"></div></div>
    <div class="panel"><div class="title">æœ¬å·</div><div id="map-honshu" class="map"></div></div>
    <div class="panel"><div class="title">åŒ—æµ·é“</div><div id="map-hokkaido" class="map"></div></div>
  </div>
  <div class="note">åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ« / ãƒ‡ãƒ¼ã‚¿: Open-Meteo</div>

  <script>
  // ====== è¨­å®š ======
  const TILE = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png';
  const ATTR = '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>';

  // å„ãƒ‘ãƒãƒ«ã®å›ºå®šè¡¨ç¤ºç¯„å›²ï¼ˆå—è¥¿[lat,lon], åŒ—æ±[lat,lon]ï¼‰
  const REGION_BOUNDS = {
    kyushu:   [[24.0, 122.5], [34.2, 132.8]],  // ä¹å·ï½æ²–ç¸„
    honshu:   [[33.0, 130.0], [41.9, 142.5]],  // æœ¬å·ï¼ˆå››å›½å«ã‚€ï¼‰
    hokkaido: [[41.2, 139.0], [45.9, 146.5]],  // åŒ—æµ·é“å…¨åŸŸ
  };

  // fitBounds å¾Œã«ã‚ºãƒ¼ãƒ ã‚’ä¸Šé™ã§ã‚¯ãƒªãƒƒãƒ—ï¼ˆæ¥µç«¯ãªã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ï¼‰
  const REGION_ZOOM_MAX = {
    kyushu:   7,
    honshu:   6,
    hokkaido: 6,
  };

  // ====== éƒ½å¸‚ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ OKï¼‰ ======
  // â€» JSONãŒç„¡ã„éƒ½å¸‚ã¯åå‰ã®ã¿è¡¨ç¤ºï¼ˆæ¸©åº¦ã¯Actionså®Ÿè¡Œå¾Œã«è¡¨ç¤ºï¼‰
  const PLACES = [
    // ä¹å·ãƒ»æ²–ç¸„
    { id:"fukuoka",   name:"ç¦å²¡å¸‚",   pref:"ç¦å²¡çœŒ",   lat:33.58333, lon:130.39999 },
    { id:"miyazaki",  name:"å®®å´å¸‚",   pref:"å®®å´çœŒ",   lat:31.90778, lon:131.42028 },
    { id:"kagoshima", name:"é¹¿å…å³¶å¸‚", pref:"é¹¿å…å³¶çœŒ", lat:31.56670, lon:130.55000 },
    { id:"naha",      name:"é‚£è¦‡å¸‚",   pref:"æ²–ç¸„çœŒ",   lat:26.21240, lon:127.68093 }, // ä»»æ„ï¼ˆæœªç”Ÿæˆã§ã‚‚OKï¼‰

    // æœ¬å·ï¼ˆå››å›½å«ã‚€ï¼‰
    { id:"osaka",     name:"å¤§é˜ªå¸‚",   pref:"å¤§é˜ªåºœ",   lat:34.69374, lon:135.50217 },
    { id:"nagoya",    name:"åå¤å±‹å¸‚", pref:"æ„›çŸ¥çœŒ",   lat:35.18145, lon:136.90640 },
    { id:"hiroshima", name:"åºƒå³¶å¸‚",   pref:"åºƒå³¶çœŒ",   lat:34.39161, lon:132.45182 },
    { id:"niigata",   name:"æ–°æ½Ÿå¸‚",   pref:"æ–°æ½ŸçœŒ",   lat:37.91611, lon:139.03639 },
    { id:"toyama",    name:"å¯Œå±±å¸‚",   pref:"å¯Œå±±çœŒ",   lat:36.69592, lon:137.21369 },
    { id:"morioka",   name:"ç››å²¡å¸‚",   pref:"å²©æ‰‹çœŒ",   lat:39.70000, lon:141.15000 },
    { id:"sendai",    name:"ä»™å°å¸‚",   pref:"å®®åŸçœŒ",   lat:38.26884, lon:140.87194 },
    { id:"chiyoda",   name:"åƒä»£ç”°",   pref:"æ±äº¬éƒ½",   lat:35.69000, lon:139.76000 },
    { id:"kisarazu",  name:"æœ¨æ›´æ´¥å¸‚", pref:"åƒè‘‰çœŒ",   lat:35.37610, lon:139.91700 },

    // åŒ—æµ·é“ï¼ˆä»£è¡¨ã¯æœ­å¹Œã«å·®ã—æ›¿ãˆï¼‰
    { id:"sapporo",   name:"æœ­å¹Œå¸‚",   pref:"åŒ—æµ·é“",   lat:43.06417, lon:141.34694 },
    // ä¾‹ï¼‰{ id:"hakodate", name:"å‡½é¤¨å¸‚", pref:"åŒ—æµ·é“", lat:41.76861, lon:140.72889 },
  ];

  // ====== å…±é€šé–¢æ•° ======
  function iconText(text){
    return L.divIcon({ className:"wx-label", html:text, iconSize:null, iconAnchor:[0,0] });
  }
  async function loadJSON(id){
    try{
      const res = await fetch(`data/${id}.json?ts=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) return null;
      return await res.json();
    }catch{ return null; }
  }
  function wcToEmoji(wc){
    return ({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",
             61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"})[wc] ?? "â›…";
  }
  function subset(region){
    if(region==="kyushu")   return PLACES.filter(p => ["ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"].includes(p.pref));
    if(region==="hokkaido") return PLACES.filter(p => p.pref==="åŒ—æµ·é“");
    return PLACES.filter(p => !["åŒ—æµ·é“","ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ"].includes(p.pref)); // æœ¬å·
  }

  // ====== ãƒãƒƒãƒ—ç”Ÿæˆï¼ˆå›ºå®šç¯„å›²ï¼‹ã‚ºãƒ¼ãƒ ä¸Šé™ã‚¯ãƒªãƒƒãƒ—ï¼‰ ======
  async function buildMap(elId, regionKey){
    const m = L.map(elId, {
      zoomControl:false, attributionControl:false,
      dragging:false, scrollWheelZoom:false, doubleClickZoom:false,
      touchZoom:false, boxZoom:false, keyboard:false
    });
    L.tileLayer(TILE, { attribution: ATTR, maxZoom: 17 }).addTo(m);

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®š â†’ ã‚µã‚¤ã‚ºå†è¨ˆç®— â†’ fitBounds â†’ æœ€å¤§ã‚ºãƒ¼ãƒ ã§ã‚¯ãƒªãƒƒãƒ—
    setTimeout(() => {
      m.invalidateSize(true);
      m.fitBounds(REGION_BOUNDS[regionKey], { padding:[20,20] });
      const zmax = REGION_ZOOM_MAX[regionKey] ?? m.getZoom();
      if (m.getZoom() > zmax) m.setZoom(zmax);
    }, 0);

    // ãƒ©ãƒ™ãƒ«æç”»
    const list = subset(regionKey);
    for(const p of list){
      const j  = await loadJSON(p.id);
      const t  = j?.current?.temperature_2m;
      const wc = j?.current?.weather_code ?? j?.daily?.weather_code?.[0];
      const label = (typeof t === "number") ? `${wcToEmoji(wc)} ${Math.round(t)}â„ƒ` : `${p.name}`;
      L.marker([p.lat,p.lon], { icon: iconText(label) }).addTo(m);
    }
  }

  // ====== åˆæœŸåŒ–ï¼†å®šæœŸæ›´æ–° ======
  window.addEventListener("load", async () => {
    await Promise.all([
      buildMap("map-kyushu",   "kyushu"),
      buildMap("map-honshu",   "honshu"),
      buildMap("map-hokkaido", "hokkaido"),
    ]);
    // 10åˆ†ã”ã¨ã«ãƒšãƒ¼ã‚¸æ›´æ–°ï¼ˆJSONã®è‡ªå‹•æ›´æ–°ã‚’ç¢ºå®Ÿã«åæ˜ ï¼‰
    setInterval(() => {
      const base = location.href.split("#")[0].split("?")[0];
      location.replace(`${base}?v=${Date.now()}`);
    }, 10 * 60 * 1000);
  });
  </script>
</body>
</html>
