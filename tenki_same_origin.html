<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤©æ°—ãƒãƒƒãƒ—ï¼ˆå…¨å›½ï¼‹åŒ—æµ·é“ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼‰</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <style>
    html,body { height:100%; margin:0; background:#0b1220; color:#eaeef5;
      font-family: system-ui, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    #map { height:100%; }
    .leaflet-popup-content{ margin:10px 12px; }

    /* ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼ˆå³ä¸Šï¼‰ */
    #inset {
      position: absolute; right: 14px; top: 14px; width: 360px; height: 240px;
      border-radius: 10px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(10,14,26,.35); backdrop-filter: blur(2px);
    }
    #inset .title {
      position:absolute; left:10px; top:6px; z-index:10; font-weight:800;
      text-shadow: 0 0 3px rgba(0,0,0,.7), 0 0 6px rgba(0,0,0,.4);
    }
    #inset-map { width:100%; height:100%; }

    /* ãƒ©ãƒ™ãƒ«ï¼ˆèƒŒæ™¯ãƒã‚¹ã‚¯ãªã—ï¼‰ */
    .wx-label {
      font-weight: 700; font-size: 16px; line-height: 1; white-space: nowrap; pointer-events: none;
      color:#fff; text-shadow: 0 0 2px rgba(0,0,0,.65), 0 0 4px rgba(0,0,0,.35);
    }
    .pref-label {
      font-weight: 800; font-size: 18px; line-height: 1; white-space: nowrap; pointer-events: none;
      color:#fff; text-shadow: 0 0 3px rgba(0,0,0,.7), 0 0 6px rgba(0,0,0,.4);
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer { position:fixed; left:0; right:0; bottom:0;
      padding:6px 10px; font-size:.8rem; opacity:.85; background:rgba(0,0,0,.25); }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- å³ä¸Šï¼šåŒ—æµ·é“ã‚¤ãƒ³ã‚»ãƒƒãƒˆ -->
  <div id="inset">
    <div class="title">åŒ—æµ·é“</div>
    <div id="inset-map"></div>
  </div>

  <div class="footer">ãƒ‡ãƒ¼ã‚¿: Open-Meteo / åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆå‡ºå…¸ï¼šå›½åœŸåœ°ç†é™¢ï¼‰</div>

  <script>
    // ===== éƒ½å¸‚ãƒªã‚¹ãƒˆï¼ˆpref ä»˜ãï¼‰ =====
    const PLACES = [
      { id: "kisarazu", name: "æœ¨æ›´æ´¥å¸‚", pref:"åƒè‘‰çœŒ",   lat: 35.3761,  lon: 139.917   },
      { id: "nagoya",   name: "åå¤å±‹å¸‚", pref:"æ„›çŸ¥çœŒ",   lat: 35.18145, lon: 136.90640 },
      { id: "osaka",    name: "å¤§é˜ªå¸‚",   pref:"å¤§é˜ªåºœ",   lat: 34.69374, lon: 135.50217 },
      { id: "hiroshima",name: "åºƒå³¶å¸‚",   pref:"åºƒå³¶çœŒ",   lat: 34.39161, lon: 132.45182 },
      { id: "fukuoka",  name: "ç¦å²¡å¸‚",   pref:"ç¦å²¡çœŒ",   lat: 33.58333, lon: 130.39999 },
      { id: "morioka",  name: "ç››å²¡å¸‚",   pref:"å²©æ‰‹çœŒ",   lat: 39.70000, lon: 141.15000 },
      { id: "hakodate", name: "å‡½é¤¨å¸‚",   pref:"åŒ—æµ·é“",   lat: 41.76861, lon: 140.72889 },
      { id: "niigata",  name: "æ–°æ½Ÿå¸‚",   pref:"æ–°æ½ŸçœŒ",   lat: 37.91611, lon: 139.03639 },
      { id: "toyama",   name: "å¯Œå±±å¸‚",   pref:"å¯Œå±±çœŒ",   lat: 36.69592, lon: 137.21369 },
      { id: "miyazaki", name: "å®®å´å¸‚",   pref:"å®®å´çœŒ",   lat: 31.90778, lon: 131.42028 },
      { id: "kagoshima",name: "é¹¿å…å³¶å¸‚", pref:"é¹¿å…å³¶çœŒ", lat: 31.56670, lon: 130.55000 },
      { id: "chiyoda",  name: "åƒä»£ç”°",   pref:"æ±äº¬éƒ½",   lat: 35.69000, lon: 139.76000 },
      { id: "sendai",   name: "ä»™å°å¸‚",   pref:"å®®åŸçœŒ",   lat: 38.26884, lon: 140.87194 },
      // åŒ—æµ·é“ã®è¿½åŠ éƒ½å¸‚ãŒã‚ã‚Œã°ã“ã“ã«è¿½è¨˜
      // ä¾‹ï¼‰{ id:"sapporo", name:"æœ­å¹Œå¸‚", pref:"åŒ—æµ·é“", lat:43.06417, lon:141.34694 },
    ];

    // ===== å…±é€šé–¢æ•° =====
    function iconText(text, isPref=false) {
      return L.divIcon({ className: isPref ? "pref-label" : "wx-label", html: text, iconSize: null, iconAnchor: [0,0] });
    }
    async function loadJSON(id) {
      const url = `data/${id}.json?ts=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }
    function wcToEmoji(wc) {
      return ({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ¦",61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"})[wc] ?? "â›…";
    }
    function avgLatLon(points){ return [ points.reduce((s,p)=>s+p[0],0)/points.length, points.reduce((s,p)=>s+p[1],0)/points.length ]; }

    // ===== ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—ï¼ˆå…¨å›½ï¼šåŒ—æµ·é“ã‚’é™¤ãéƒ½é“åºœçœŒã‚µãƒãƒªï¼‰ =====
    const map = L.map('map', { zoomControl: true });
    const baseUrl = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png';
    L.tileLayer(baseUrl, { attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>' }).addTo(map);

    // å…ˆã«å…¨å›½ã‚’ã»ã©ã‚ˆã„ç¯„å›²ã«
    const nonHokkaidoCoords = PLACES.filter(p => p.pref !== "åŒ—æµ·é“").map(p => [p.lat,p.lon]);
    map.fitBounds(L.latLngBounds(nonHokkaidoCoords), { padding:[20,20] });

    const prefLayer = L.layerGroup().addTo(map);
    const cityData = new Map();

    async function buildCityData() {
      cityData.clear();
      for (const p of PLACES) {
        try {
          const j = await loadJSON(p.id);
          const c = j.current || {};
          const d = j.daily   || {};
          const t  = (c.temperature_2m != null) ? Math.round(c.temperature_2m) : null;
          const wc = (c.weather_code ?? d.weather_code?.[0]);
          cityData.set(p.id, { place:p, temp:t, wc, updatedAt:j.updatedAt });
        } catch(e) {
          cityData.set(p.id, { place:p, temp:null, wc:null, updatedAt:null });
        }
      }
    }

    function buildPrefSummary(excludePref = null) {
      prefLayer.clearLayers();
      // prefecture -> array of records
      const groups = {};
      for (const p of PLACES) {
        if (excludePref && p.pref === excludePref) continue;  // åŒ—æµ·é“ã¯ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é™¤å¤–
        const rec = cityData.get(p.id);
        if (!groups[p.pref]) groups[p.pref] = [];
        groups[p.pref].push(rec || { place:p, temp:null, wc:null });
      }
      for (const [pref, arr] of Object.entries(groups)) {
        const points = arr.map(r => [r.place.lat, r.place.lon]);
        const [lat,lon] = avgLatLon(points);
        const temps = arr.map(r => r.temp).filter(v => typeof v === "number");
        const avgT  = temps.length ? Math.round(temps.reduce((a,b)=>a+b,0)/temps.length) : null;
        const wc    = (arr.find(r => typeof r.wc === "number")?.wc) ?? null;
        const emo   = wcToEmoji(wc);
        const text  = (avgT==null) ? `${pref}` : `${pref} ${emo} ${avgT}â„ƒ`;
        L.marker([lat,lon], { icon: iconText(text, true) })
         .bindPopup(`<b>${pref}</b><div>ç™»éŒ²éƒ½å¸‚: ${arr.length} ä»¶</div>`)
         .addTo(prefLayer);
      }
    }

    // ===== åŒ—æµ·é“ã‚¤ãƒ³ã‚»ãƒƒãƒˆï¼ˆéƒ½å¸‚ãƒ©ãƒ™ãƒ«è¡¨ç¤ºï¼‰ =====
    const insetMap = L.map('inset-map', { attributionControl:false, zoomControl:false, dragging:false, scrollWheelZoom:false, doubleClickZoom:false, boxZoom:false, keyboard:false });
    L.tileLayer(baseUrl, { attribution: '' }).addTo(insetMap);
    const insetLayer = L.layerGroup().addTo(insetMap);

    function buildHokkaidoInset() {
      insetLayer.clearLayers();
      const hk = PLACES.filter(p => p.pref === "åŒ—æµ·é“");
      if (!hk.length) return;
      // ãƒ“ãƒ¥ãƒ¼ã‚’åŒ—æµ·é“ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆå°‘ã—ä½™ç™½å¤šã‚ï¼‰
      insetMap.fitBounds(L.latLngBounds(hk.map(p => [p.lat,p.lon])), { padding:[20,20] });

      for (const p of hk) {
        const rec = cityData.get(p.id);
        const t = rec?.temp, wc = rec?.wc;
        const label = (t==null) ? `${p.name}` : `${wcToEmoji(wc)} ${t}â„ƒ`;
        L.marker([p.lat,p.lon], { icon: iconText(label, false) })
         .bindPopup(`<b>${p.name}ï¼ˆ${p.pref}ï¼‰</b><div>ç¾åœ¨ ${t??"-"}â„ƒ</div>`)
         .addTo(insetLayer);
      }
    }

    // ===== åˆæœŸåŒ–ï¼†å®šæœŸæ›´æ–° =====
    (async () => {
      await buildCityData();
      buildPrefSummary("åŒ—æµ·é“"); // ãƒ¡ã‚¤ãƒ³ã¯åŒ—æµ·é“ã‚’é™¤å¤–
      buildHokkaidoInset();       // ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«åŒ—æµ·é“
    })();

    // 10åˆ†ã”ã¨ã«è‡ªå·±ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆJSONæ›´æ–°ã‚’ç¢ºå®Ÿåæ˜ ï¼‰
    setInterval(() => {
      const base = location.href.split("#")[0].split("?")[0];
      location.replace(`${base}?v=${Date.now()}`);
    }, 10 * 60 * 1000);
  </script>
</body>
</html>
