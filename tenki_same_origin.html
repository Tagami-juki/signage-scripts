<!doctype html><html lang="ja"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤©æ°—ãƒãƒƒãƒ—ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ï¼‰</title>
<link rel="preconnect" href="https://{s}.gsi.go.jp">
<style>
  html,body,#map{height:100%;margin:0;background:#0b1220;color:#eaeef5;font-family:system-ui,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
  .leaflet-popup-content{margin:10px 12px}
  .card{line-height:1.4}
  .mini{opacity:.8;font-size:.85rem}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:6px 10px;font-size:.8rem;opacity:.8;background:rgba(0,0,0,.25)}
</style>
<div id="map"></div>
<div class="footer">ãƒ‡ãƒ¼ã‚¿: Open-Meteo / åœ°å›³: åœ°ç†é™¢ã‚¿ã‚¤ãƒ«ï¼ˆå‡ºå…¸ï¼šå›½åœŸåœ°ç†é™¢ï¼‰</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<link  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" crossorigin>

<script>
const PLACES = [
  { id:"chiyoda", name:"åƒä»£ç”°", lat:35.69, lon:139.76 },
  { id:"narita",  name:"æˆç”°",   lat:35.77, lon:140.39 },
  { id:"sendai",  name:"ä»™å°",   lat:38.27, lon:140.87 },
];

const map = L.map('map',{zoomControl:false}).setView([36.2,139.7],6);
L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',{
  attribution:'&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>'
}).addTo(map);

const markers = L.layerGroup().addTo(map);

function iconHtml(t){return L.divIcon({
  className:"wx", iconSize:[80,28], html:`<div style="background:#1a2440;border:1px solid #2a3a66;border-radius:6px;padding:4px 8px;">
    <b style="font-size:1rem">${t}</b></div>`
});}

async function loadJSON(id){
  const url = `data/${id}.json?ts=${Date.now()}`;
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
  return await res.json();
}

function wcToEmoji(wc){
  // ç°¡æ˜“ï¼šå¿…è¦ãªã‚‰å¾Œã§è©³ç´°åŒ–
  return {0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",61:"ğŸŒ§",71:"ğŸŒ¨"}[wc] || "â›…";
}

async function render(){
  markers.clearLayers();
  for (const p of PLACES){
    try{
      const j = await loadJSON(p.id);
      const c = j.current || {};
      const d = j.daily   || {};
      const t  = (c.temperature_2m!=null) ? Math.round(c.temperature_2m) : "-";
      const tH = (d.temperature_2m_max?.[0]!=null) ? Math.round(d.temperature_2m_max[0]) : "-";
      const tL = (d.temperature_2m_min?.[0]!=null) ? Math.round(d.temperature_2m_min[0]) : "-";
      const emo= wcToEmoji(c.weather_code ?? d.weather_code?.[0]);

      const m = L.marker([p.lat,p.lon],{icon:iconHtml(`${emo} ${t}â„ƒ`)}).addTo(markers);
      const upd = j.updatedAt ? new Date(j.updatedAt).toLocaleString("ja-JP") : "";
      m.bindPopup(`<div class="card">
        <div><b>${p.name}</b></div>
        <div>ç¾åœ¨ ${t}â„ƒ / â†‘${tH}â„ƒ / â†“${tL}â„ƒ</div>
        <div class="mini">æœ€çµ‚æ›´æ–°: ${upd}</div>
      </div>`);
    }catch(e){
      const m = L.marker([p.lat,p.lon],{icon:iconHtml("N/A")}).addTo(markers);
      m.bindPopup(`<div class="card"><b>${p.name}</b><div>JSONèª­ã¿è¾¼ã¿å¤±æ•—</div><div class="mini">${String(e).slice(0,80)}</div></div>`);
    }
  }
}
render();

// 10åˆ†ã”ã¨ã«å…¨ä½“æ›´æ–°ï¼ˆYodeckã®è‡ªå‹•å†èª­è¾¼ã«åŠ ãˆã¦ä¿é™ºï¼‰
setInterval(()=>location.replace(location.href.split("#")[0]+`?v=${Date.now()}`), 10*60*1000);
</script>
