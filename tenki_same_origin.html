<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å…¨å›½å¤©æ°—3åˆ†å‰²ãƒãƒƒãƒ—</title>

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body {height:100%; margin:0; background:#0b1220; display:flex;}
    .panel {flex:1; border-left:1px solid #333; position:relative;}
    .map {width:100%; height:100%;}
    .title {
      position:absolute; left:8px; top:6px; z-index:10; font-weight:800; color:#fff;
      text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.4);
    }
    .wx-label {
      font-weight:700; font-size:16px; color:#fff; pointer-events:none;
      text-shadow:0 0 2px rgba(0,0,0,.65),0 0 4px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div class="panel"><div class="title">ä¹å·ãƒ»æ²–ç¸„</div><div id="map-kyushu" class="map"></div></div>
  <div class="panel"><div class="title">æœ¬å·</div><div id="map-honshu" class="map"></div></div>
  <div class="panel"><div class="title">åŒ—æµ·é“</div><div id="map-hokkaido" class="map"></div></div>

  <script>
    const PLACES = [
      // ä¹å·ãƒ»æ²–ç¸„
      { id:"fukuoka", name:"ç¦å²¡å¸‚", pref:"ç¦å²¡çœŒ", lat:33.58333, lon:130.39999 },
      { id:"miyazaki",name:"å®®å´å¸‚", pref:"å®®å´çœŒ", lat:31.90778, lon:131.42028 },
      { id:"kagoshima",name:"é¹¿å…å³¶å¸‚",pref:"é¹¿å…å³¶çœŒ",lat:31.56670, lon:130.55000 },
      // æœ¬å·
      { id:"osaka",   name:"å¤§é˜ªå¸‚", pref:"å¤§é˜ªåºœ", lat:34.69374, lon:135.50217 },
      { id:"nagoya",  name:"åå¤å±‹å¸‚",pref:"æ„›çŸ¥çœŒ", lat:35.18145, lon:136.90640 },
      { id:"hiroshima",name:"åºƒå³¶å¸‚", pref:"åºƒå³¶çœŒ", lat:34.39161, lon:132.45182 },
      { id:"niigata", name:"æ–°æ½Ÿå¸‚", pref:"æ–°æ½ŸçœŒ", lat:37.91611, lon:139.03639 },
      { id:"toyama",  name:"å¯Œå±±å¸‚", pref:"å¯Œå±±çœŒ", lat:36.69592, lon:137.21369 },
      { id:"morioka", name:"ç››å²¡å¸‚", pref:"å²©æ‰‹çœŒ", lat:39.7, lon:141.15 },
      { id:"sendai",  name:"ä»™å°å¸‚", pref:"å®®åŸçœŒ", lat:38.26884, lon:140.87194 },
      { id:"chiyoda", name:"åƒä»£ç”°", pref:"æ±äº¬éƒ½", lat:35.69000, lon:139.76000 },
      // åŒ—æµ·é“
      { id:"hakodate",name:"å‡½é¤¨å¸‚", pref:"åŒ—æµ·é“", lat:41.76861, lon:140.72889 },
      // å¿…è¦ã«å¿œã˜ã¦æœ­å¹Œãªã©è¿½åŠ 
    ];

    function iconText(text){
      return L.divIcon({ className:"wx-label", html:text, iconSize:null, iconAnchor:[0,0] });
    }
    async function loadJSON(id){
      const res = await fetch(`data/${id}.json?ts=${Date.now()}`,{cache:"no-store"});
      return res.ok ? res.json() : null;
    }
    function wcToEmoji(wc){
      return ({0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",75:"ğŸŒ¨",95:"â›ˆ"})[wc] ?? "â›…";
    }

    async function build(map, subset){
      for(const p of subset){
        const j = await loadJSON(p.id);
        const t = j?.current?.temperature_2m ? Math.round(j.current.temperature_2m) : null;
        const wc = j?.current?.weather_code;
        const label = (t==null)? `${p.name}` : `${wcToEmoji(wc)} ${t}â„ƒ`;
        L.marker([p.lat,p.lon],{icon:iconText(label)}).addTo(map);
      }
      map.fitBounds(L.latLngBounds(subset.map(p=>[p.lat,p.lon])),{padding:[20,20]});
    }

    const base = 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png';
    const opts = { attribution:'&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>' };

    // 3ãƒãƒƒãƒ—ä½œæˆ
    const mapKyushu = L.map('map-kyushu',{zoomControl:false,attributionControl:false});
    L.tileLayer(base,opts).addTo(mapKyushu);
    build(mapKyushu, PLACES.filter(p=>["ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref)));

    const mapHonshu = L.map('map-honshu',{zoomControl:false,attributionControl:false});
    L.tileLayer(base,opts).addTo(mapHonshu);
    build(mapHonshu, PLACES.filter(p=>!["åŒ—æµ·é“","ç¦å²¡çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ"].includes(p.pref)));

    const mapHokkaido = L.map('map-hokkaido',{zoomControl:false,attributionControl:false});
    L.tileLayer(base,opts).addTo(mapHokkaido);
    build(mapHokkaido, PLACES.filter(p=>p.pref==="åŒ—æµ·é“"));

    // 10åˆ†ã”ã¨ã«ãƒªãƒ­ãƒ¼ãƒ‰
    setInterval(()=>location.reload(),10*60*1000);
  </script>
</body>
</html>
