<!doctype html><html lang="ja">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>天気マップ（堅牢版）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body,#map{height:100%;margin:0;background:#0b1220;color:#e6edf3;font-family:system-ui,"Noto Sans JP",sans-serif}
  .leaflet-control-attribution{font-size:12px}
  .legend{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.5);padding:8px 10px;border-radius:10px;font-size:14px}
  .popup{min-width:220px}
  .popup .t{font-size:28px;font-weight:700}
  .popup .d{opacity:.85}
  .banner{position:absolute;top:10px;left:50%;transform:translateX(-50%);
          background:#1f2b3a;border:1px solid #34465a;border-radius:12px;padding:10px 14px;
          font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);max-width:min(90vw,1200px)}
  .banner.error{background:#3a1f24;border-color:#5a343c}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
</style>
<body>
<div id="map"></div>
<div id="msg" class="banner" hidden>読み込み中…</div>
<div class="legend">データ: Open-Meteo（JMA最適化） / 地図: 地理院タイル（出典：国土地理院）</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const PLACES = [
  { name:"千代田区", lat:35.6812, lon:139.7671, zoom:7 },
  { name:"成田",     lat:35.7767, lon:140.3186 },
  { name:"仙台",     lat:38.2688, lon:140.8721 }
];
const REFRESH_MIN = 5;

const map = L.map('map', { zoomControl:false, attributionControl:true });
map.setView([PLACES[0].lat, PLACES[0].lon], PLACES[0].zoom || 6);

L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; <a href="https://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html" target="_blank">国土地理院</a>'
}).addTo(map);

const WMO = new Map([[0,"快晴"],[1,"晴れ"],[2,"晴れ時々曇り"],[3,"曇り"],[51,"霧雨(弱)"],[53,"霧雨"],[55,"霧雨(強)"],
  [61,"雨(弱)"],[63,"雨"],[65,"雨(強)"],[71,"雪(弱)"],[73,"雪"],[75,"大雪"],[80,"にわか雨"],[81,"にわか強雨"],[82,"激しいにわか雨"],[95,"雷雨"],[96,"雷雹"],[99,"激しい雷雹"]]);

function showMsg(text, isErr=false){
  const b = document.getElementById('msg');
  b.innerHTML = text; b.hidden = false;
  b.classList.toggle('error', isErr);
}
function esc(s){return String(s).replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]))}

async function fetchWithTimeout(url, opts={}, timeoutMs=12000){
  const ctl = new AbortController();
  const id = setTimeout(()=>ctl.abort(), timeoutMs);
  try {
    const res = await fetch(url, {...opts, signal: ctl.signal});
    return res;
  } finally { clearTimeout(id); }
}

async function getForecast(lat,lon){
  const base = 'https://api.open-meteo.com/v1/forecast';
  const common = {
    latitude:lat, longitude:lon, timezone:'Asia/Tokyo',
    current:'temperature_2m,weather_code',
    daily:'temperature_2m_max,temperature_2m_min',
    forecast_days:1
  };

  // 1) JMA最適化モデルで試行
  let url = new URL(base); Object.assign(url.searchParams, {...common, models:'jma_seamless', _cb:Date.now()});
  let res = await fetchWithTimeout(url, {cache:'no-store'});
  let data = await parseJsonSafe(res, 'JMA');

  // 2) だめならフォールバック（モデル未指定）
  if(!data){
    url = new URL(base); Object.assign(url.searchParams, {...common, _cb:Date.now()});
    res = await fetchWithTimeout(url, {cache:'no-store'});
    data = await parseJsonSafe(res, 'fallback');
  }
  if(!data) throw new Error('Open-MeteoがJSONを返しません（両方失敗）');
  return data;
}

async function parseJsonSafe(res, label){
  if(!res) return null;
  const ct = res.headers.get('content-type') || '';
  const status = res.status;
  const text = await res.text(); // ← まず文字列で受ける
  const info = `[${label}] status=${status}, ct=${ct}, len=${text.length}`;
  if(!res.ok){ showMsg(`HTTPエラー ${info}<div class="mono">${esc(text.slice(0,200))}</div>`, true); return null; }
  if(!/json/i.test(ct)){ showMsg(`JSONでない応答 ${info}<div class="mono">${esc(text.slice(0,200))}</div>`, true); return null; }
  if(text.length < 2){ showMsg(`空の応答 ${info}`, true); return null; }
  try{
    return JSON.parse(text);
  }catch(e){
    showMsg(`JSONパース失敗 ${info}<div class="mono">${esc(text.slice(0,200))}</div>`, true);
    return null;
  }
}

async function addMarkers(){
  showMsg('天気データ取得中…');
  let ok = 0;
  for(const p of PLACES){
    try{
      const j = await getForecast(p.lat,p.lon);
      const cur = j.current, max = Math.round(j.daily.temperature_2m_max[0]), min = Math.round(j.daily.temperature_2m_min[0]);
      const marker = L.marker([p.lat,p.lon]).addTo(map);
      const desc = WMO.get(cur.weather_code) || '—';
      marker.bindPopup(`<div class="popup"><div class="t">${p.name}　${Math.round(cur.temperature_2m)}°C</div>
        <div class="d">${desc}　↑${max}° / ↓${min}°</div></div>`);
      ok++;
    }catch(e){
      console.error(e);
      showMsg(`「${p.name}」の取得に失敗：${esc(e.message)}`, true);
    }
  }
  if(ok>0) showMsg('更新: '+new Date().toLocaleTimeString('ja-JP'));
}

(async function init(){
  await addMarkers();                 // まずピンを出す
})();
setInterval(()=>location.reload(), REFRESH_MIN*60*1000);
</script>
</body></html>
